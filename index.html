<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PROMPT STREAM // HYBRID</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Share+Tech+Mono&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg-color: #050505; --palette-bg: #111518; --stream-bg: #0e1215; --card-bg: #161a1e;
      --primary: #00f3ff; --secondary: #ffaa00; --accent: #ff0055;
      --code-color: #00ff99; --char-color: #ff00cc; --part-color: #bd00ff;
      --text-main: #cceeee; --text-dim: #668888; --border-color: #334444;
      --header-height: 50px; --footer-height: 60px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { font-family: 'Share Tech Mono', 'Zen Kaku Gothic New', monospace; background-color: var(--bg-color); color: var(--text-main); margin: 0; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; }
    
    /* Header */
    header { height: var(--header-height); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: rgba(11, 15, 18, 0.98); z-index: 20; flex-shrink: 0; }
    h1 { font-size: 16px; color: var(--text-main); margin: 0; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 20%; }
    .actions { display: flex; gap: 6px; align-items: center; }
    .actions button { background: transparent; border: 1px solid var(--border-color); color: var(--primary); padding: 6px 8px; font-family: 'Share Tech Mono'; cursor: pointer; font-size: 11px; border-radius: 4px; min-width: 36px; white-space: nowrap; }
    .actions button:active { background: var(--primary); color: #000; }
    .btn-link { text-decoration: none; display: inline-flex; } .btn-link button { border-color: var(--char-color); color: var(--char-color); } .btn-link button:active { background: var(--char-color); color: #fff; }
    .actions button.accent { border-color: var(--secondary); color: var(--secondary); } .actions button.accent:active { background: var(--secondary); color: #000; }
    .actions button.danger { border-color: var(--accent); color: var(--accent); } .actions button.danger:active { background: var(--accent); color: #000; }
    /* Mode Toggle Button */
    .btn-mode { border-color: #fff !important; color: #fff !important; background: #333 !important; }

    /* Palette */
    .palette { background: var(--palette-bg); padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; gap: 8px; overflow-x: auto; flex-shrink: 0; align-items: center; z-index: 15; }
    .palette::-webkit-scrollbar { height: 2px; }
    .add-btn { flex: 0 0 auto; background: #000; border: 1px solid var(--border-color); border-left: 3px solid #555; color: var(--text-main); padding: 8px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; min-width: 75px; }
    .add-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
    .add-btn span { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
    .btn-inline { border-color: #fff; border-style: dashed; background: #222; align-items: center; justify-content: center; min-width: 50px; }
    .btn-part { border-color: var(--part-color); color: var(--part-color); border-style: dotted; }
    .btn-speech { border-left-color: var(--primary); } .btn-char { border-left-color: var(--char-color); } .btn-code { border-left-color: var(--code-color); } .btn-snip { border-left-color: var(--secondary); border-style: dotted; }

    /* Stream Container */
    .stream-container { flex: 1; background: var(--stream-bg); padding: 15px 10px; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; transition: padding 0.3s; }
    /* Mode specific padding */
    body.mode-rapid .stream-container { padding-bottom: 80px; }
    body.mode-standard .stream-container { padding-bottom: 20px; }

    /* Cards */
    .card { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 3px solid var(--text-dim); margin-bottom: 12px; padding: 0; position: relative; border-radius: 4px; display: flex; flex-direction: column; }
    .card-header-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); border-top-right-radius: 4px; }
    .card-label-btn { font-size: 10px; color: var(--secondary); text-transform: uppercase; cursor: pointer; user-select: none; font-weight: bold; padding: 2px 6px; border-radius: 4px; transition: 0.2s; }
    .card-label-btn:active { background: rgba(255,255,255,0.1); } .card-label-btn::after { content: ' ‚Üª'; font-size: 9px; opacity: 0.5; }
    .card-controls { display: flex; align-items: center; gap: 8px; }
    .card-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #333; background: #000; color: #777; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .card-btn:hover { color: #fff; border-color: #555; }
    .card-btn.del:hover { color: var(--accent); border-color: var(--accent); } .card-btn.clone:hover { color: var(--code-color); border-color: var(--code-color); } .card-btn.copy:hover { color: var(--primary); border-color: var(--primary); }
    .drag-handle { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--border-color); font-size: 18px; cursor: grab; touch-action: none; } .drag-handle::after { content: '‚â°'; }
    .card textarea { width: 100%; padding: 12px; background: transparent; border: none; color: var(--text-main); resize: none; font-family: 'Zen Kaku Gothic New', monospace; font-size: 15px; line-height: 1.5; outline: none; min-height: 50px; max-height: 300px; display: block; }
    
    .type-speech { border-left-color: var(--primary); } .type-speech .card-label-btn { color: var(--primary); }
    .type-char { border-left-color: var(--char-color); background: #1a0f15; } .type-char .card-label-btn { color: var(--char-color); }
    .type-code { border-left-color: var(--code-color); background: #080a0c; } .type-code .card-label-btn { color: var(--code-color); } .type-code textarea { font-family: 'Fira Code', monospace; color: var(--code-color); font-size: 13px; }
    .type-free { border-left-color: var(--text-dim); } .type-free .card-label-btn { color: var(--text-dim); }

    /* Rapid Fire Footer */
    .rapid-footer {
      height: var(--footer-height); border-top: 1px solid var(--border-color);
      background: #111518; padding: 0 10px; display: flex; align-items: center; gap: 10px;
      position: absolute; bottom: 0; left: 0; width: 100%; z-index: 30;
      transform: translateY(0); transition: transform 0.3s;
    }
    .rapid-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 20px; font-family: 'Zen Kaku Gothic New', monospace; font-size: 14px; outline: none; height: 40px; transition: 0.2s; }
    .rapid-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,243,255,0.1); }
    .rapid-send { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); border: none; color: #000; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .rapid-send:active { transform: scale(0.9); background: #fff; }

    /* Mode States */
    body.mode-standard .rapid-footer { transform: translateY(100%); } /* Hide footer */
    
    /* Modals & Others */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal-content { background: #111518; border: 1px solid var(--secondary); width: 90%; max-width: 450px; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    .modal-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.05); color: var(--text-main); font-weight: bold; font-size: 14px; }
    .modal-body { padding: 15px; overflow-y: auto; }
    .share-options button { width: 100%; padding: 15px; margin-bottom: 12px; background: #1e1e24; border: 1px solid var(--border-color); color: var(--text-main); text-align: left; cursor: pointer; border-radius: 8px; font-family: 'Share Tech Mono'; display: flex; justify-content: space-between; align-items: center; }
    .share-options button:active { border-color: var(--primary); background: #2a2a35; transform: scale(0.98); }
    .share-options button span { color: var(--text-dim); font-size: 10px; background:#000; padding:2px 6px; border-radius:4px; }
    .share-icon { margin-right: 8px; font-size: 16px; }
    .tag-filter { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid var(--border-color); margin-bottom: 15px; }
    .list-item { background: var(--card-bg); border: 1px solid var(--border-color); padding: 12px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    .list-info { display: flex; flex-direction: column; width: 65%; }
    .list-tag { font-size: 10px; background: #333; padding: 2px 5px; border-radius: 3px; width: fit-content; margin-bottom: 4px; color: #aaa; }
    .list-name { font-size: 14px; font-weight: bold; color: var(--text-main); }
    .btn-group { display: flex; gap: 6px; }
    .btn-sm { padding: 6px 10px; font-size: 11px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }
    .btn-load { background: var(--primary); color: #000; } .btn-del { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
    .part-chip { display: inline-block; padding: 8px 12px; margin: 4px; background: rgba(189, 0, 255, 0.1); border: 1px solid var(--part-color); color: var(--part-color); border-radius: 20px; font-family: monospace; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .part-chip:active { background: var(--part-color); color: #fff; } .part-chip .del { font-weight: bold; margin-left: 8px; color: var(--accent); opacity: 0.7; } .part-container { display: flex; flex-wrap: wrap; gap: 5px; }
    .save-form input { width: 100%; padding: 8px; margin-bottom: 8px; background: #000; border: 1px solid #444; color: #fff; }
    .btn-save-new { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; background: var(--secondary); color:#000; }
    #charModal .modal-content { border-color: var(--char-color); } #partModal .modal-content { border-color: var(--part-color); }
    #snippetModal .modal-content { border-color: var(--code-color); } #shareModal .modal-content { border-color: var(--primary); }
  </style>
</head>
<body class="mode-rapid"> <header>
    <h1>PROMPT<span>v10</span></h1>
    <div class="actions">
      <button class="btn-mode" onclick="toggleMode()">‚ö° MODE</button>
      <a href="./persona.html" class="btn-link"><button title="Persona">PERSONA‚Üí</button></a>
      <button onclick="clearBoard()" class="danger">CLR</button>
      <button onclick="openCharModal()" style="border-color:var(--char-color); color:var(--char-color);">CHARS</button>
      <button onclick="openProjectModal()" class="accent">DATA</button>
      <button onclick="openShareModal()" style="border-color:var(--primary); color:var(--primary); font-weight:bold;">SHARE</button>
    </div>
  </header>

  <div class="palette">
    <div class="add-btn btn-inline" onmousedown="insertWildcard(event)">****<span>WILD</span></div>
    <div class="add-btn btn-inline" onmousedown="insertBracket(event)">[ ]<span>BRA</span></div>
    <div class="add-btn btn-inline" onmousedown="insertSeparator(event)">---<span>SEP</span></div>
    <div class="add-btn btn-inline btn-part" onmousedown="openPartModal(event)">WORDS<span>PARTS</span></div>

    <div class="add-btn btn-speech" onclick="addNewCard('speech')">Dialogue<span>‰ºöË©±</span></div>
    <div class="add-btn btn-char" onclick="addNewCard('char_def')">Character<span>‰∫∫Ê†º</span></div>
    <div class="add-btn btn-code" onclick="addNewCard('code')">Code<span>„É≠„Ç∏„ÉÉ„ÇØ</span></div>
    <div class="add-btn" onclick="addNewCard('free')">Text<span>Âú∞Êñá</span></div>
    <div class="add-btn btn-snip" onclick="openSnippetModal()">Snippet<span>VBA</span></div>
  </div>

  <div class="stream-container">
    <div id="streamList">
      <p style="text-align:center; color:var(--border-color); font-size:12px; margin-top:50px;">TAP PALETTE or TYPE BELOW</p>
    </div>
  </div>

  <div class="rapid-footer">
    <input type="text" id="rapidInput" class="rapid-input" placeholder="Rapid Fire Mode..." onkeypress="handleRapidKey(event)">
    <button class="rapid-send" onclick="sendRapidFire()">‚Üë</button>
  </div>

  <div id="shareModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header" style="color:var(--primary);">SYSTEM SHARE <span onclick="document.getElementById('shareModal').style.display='none'" style="cursor:pointer; font-size:20px;">√ó</span></div>
      <div class="modal-body share-options">
        <button onclick="shareContent('text')"><div><span class="share-icon">üöÄ</span>SHARE TEXT</div><span>„Çπ„Éû„ÉõÂÖ±Êúâ</span></button>
        <button onclick="shareContent('code')"><div><span class="share-icon">ü§ñ</span>SHARE FOR AI</div><span>„Ç≥„Éº„ÉâÂåñÂÖ±Êúâ</span></button>
        <button onclick="shareAsFile('txt')"><div><span class="share-icon">üìÑ</span>SHARE .TXT FILE</div><span>„Éï„Ç°„Ç§„É´Ëª¢ÈÄÅ</span></button>
        <div style="border-bottom:1px solid #333; margin:10px 0;"></div>
        <button onclick="downloadFile('md')" style="border-color:#444; color:#777;"><div><span class="share-icon">üíæ</span>DOWNLOAD .MD</div><span>‰øùÂ≠ò„ÅÆ„Åø</span></button>
      </div>
    </div>
  </div>

  <div id="charModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--char-color);">CHARACTER LIBRARY <span onclick="document.getElementById('charModal').style.display='none'" style="cursor:pointer; font-size:20px;">√ó</span></div><div class="modal-body"><p style="font-size:11px; color:#666;">‚Äª Manage details in <a href="./persona.html" style="color:var(--char-color);">PERSONA ARCHIVE</a></p><select id="charTagFilter" class="tag-filter" onchange="renderCharList()"><option value="ALL">ALL TAGS</option></select><div id="charList"></div></div></div></div>
  <div id="projectModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--secondary);">PROJECT MANAGER <span onclick="document.getElementById('projectModal').style.display='none'" style="cursor:pointer; font-size:20px;">√ó</span></div><div class="modal-body"><div class="save-form"><input type="text" id="saveProjName" placeholder="Project Name"><input type="text" id="saveProjTag" placeholder="Tag" list="projTagList"><datalist id="projTagList"></datalist><button class="btn-save-new" onclick="saveCurrentBoard()">+ SAVE CURRENT BOARD</button></div><div style="border-bottom:1px solid #333; margin-bottom:15px;"></div><select id="projTagFilter" class="tag-filter" onchange="renderProjectList()"><option value="ALL">ALL TAGS</option></select><div id="projectList"></div></div></div></div>
  <div id="partModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--part-color);">INLINE PARTS <span onclick="document.getElementById('partModal').style.display='none'" style="cursor:pointer; font-size:20px;">√ó</span></div><div class="modal-body"><div id="partList" class="part-container"></div><div style="border-top:1px solid #333; margin-top:20px; padding-top:15px;"><input type="text" id="newPartText" placeholder="New Part" style="width:70%; padding:10px; background:#000; border:1px solid var(--part-color); color:var(--part-color); font-family:monospace;"><button style="width:25%; padding:10px; background:var(--part-color); border:none; color:#fff; font-weight:bold; cursor:pointer;" onclick="savePart()">ADD</button></div></div></div></div>
  <div id="snippetModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--code-color);">SNIPPETS <span onclick="document.getElementById('snippetModal').style.display='none'" style="cursor:pointer; font-size:20px;">√ó</span></div><div class="modal-body"><div id="snippetList"></div><div style="border-top:1px solid #333; margin-top:15px; padding-top:15px;"><input type="text" id="newSnipName" placeholder="Name" style="width:100%; padding:8px; margin-bottom:5px; background:#000; border:1px solid #333; color:var(--code-color);"><textarea id="newSnipContent" rows="3" placeholder="Code..." style="width:100%; padding:8px; margin-bottom:5px; background:#000; border:1px solid #333; color:var(--code-color); font-family:'Fira Code';"></textarea><button class="btn-save-new" style="background:var(--code-color); color:#000; margin:0;" onclick="saveSnippet()">ADD</button></div></div></div></div>

  <script>
    let lastFocusedTextarea = null;
    const typeOrder = ['speech', 'char_def', 'code', 'free'];
    
    new Sortable(document.getElementById('streamList'), {
      animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: () => saveToLocal()
    });

    const templates = {
      speech: { label: 'Dialogue', placeholder: '„Äå‚Ä¶‚Ä¶„Äç', rows: 2 },
      char_def: { label: 'Character', placeholder: '[AI personality...]', rows: 6 },
      code: { label: 'Logic / Code', placeholder: 'if (flag) {\n  \n}', rows: 3 },
      free: { label: 'Narration', placeholder: '...', rows: 3 }
    };

    function addNewCard(type, initialValue = null, insertAfterNode = null) {
      const list = document.getElementById('streamList'); if(list.querySelector('p')) list.innerHTML = '';
      const tmpl = templates[type];
      const div = document.createElement('div'); div.className = `card type-${type}`; div.dataset.type = type;
      
      div.innerHTML = `
        <div class="card-header-row">
          <div class="card-label-btn" title="Tap to change">${tmpl.label}</div>
          <div class="card-controls">
            <div class="card-btn copy" title="Copy">‚ùê</div>
            <div class="card-btn clone" title="Clone">Ôºã</div>
            <div class="card-btn del" title="Delete">√ó</div>
            <div class="drag-handle"></div>
          </div>
        </div>
        <textarea rows="${tmpl.rows}" placeholder="${tmpl.placeholder}">${initialValue !== null ? initialValue : ''}</textarea>
      `;
      
      if (insertAfterNode) { insertAfterNode.parentNode.insertBefore(div, insertAfterNode.nextSibling); } 
      else { list.appendChild(div); }

      setupCardEvents(div);
      if (!insertAfterNode) div.scrollIntoView({ behavior: "smooth", block: "end" });
      saveToLocal();
      const ta = div.querySelector('textarea'); 
      // Rapid Mode„Åã„Å§Input„Å´„Éï„Ç©„Éº„Ç´„Çπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂ•™„Çè„Å™„ÅÑ
      if(document.body.classList.contains('mode-standard') || document.activeElement !== document.getElementById('rapidInput')) {
        ta.focus(); lastFocusedTextarea = ta;
      }
    }

    function setupCardEvents(card) {
      const labelBtn = card.querySelector('.card-label-btn');
      labelBtn.onclick = function() {
        const currentType = card.dataset.type;
        let nextIdx = typeOrder.indexOf(currentType) + 1;
        if(nextIdx >= typeOrder.length) nextIdx = 0;
        const nextType = typeOrder[nextIdx];
        card.classList.remove(`type-${currentType}`); card.classList.add(`type-${nextType}`); card.dataset.type = nextType;
        labelBtn.innerText = templates[nextType].label;
        const ta = card.querySelector('textarea');
        if(nextType === 'code') { ta.placeholder = templates.code.placeholder; ta.style.fontFamily = "'Fira Code', monospace"; ta.style.color = "var(--code-color)"; } 
        else { ta.placeholder = templates[nextType].placeholder; ta.style.fontFamily = "'Zen Kaku Gothic New', monospace"; ta.style.color = "var(--text-main)"; }
        if(nextType === 'char_def') labelBtn.style.color = "var(--char-color)"; else if(nextType === 'speech') labelBtn.style.color = "var(--primary)"; else if(nextType === 'free') labelBtn.style.color = "var(--text-dim)";
        saveToLocal();
      };
      card.querySelector('.del').onclick = function() { if(confirm("Delete block?")) { card.remove(); saveToLocal(); } };
      card.querySelector('.clone').onclick = function() { const type = card.dataset.type; const text = card.querySelector('textarea').value; addNewCard(type, text, card); };
      card.querySelector('.copy').onclick = function() { const text = card.querySelector('textarea').value; navigator.clipboard.writeText(text).then(() => { const btn = card.querySelector('.copy'); const original = btn.innerText; btn.innerText = "‚úì"; btn.style.color = "var(--primary)"; setTimeout(() => { btn.innerText = original; btn.style.color = ""; }, 1000); }); };
      const ta = card.querySelector('textarea'); if(ta) { ta.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; saveToLocal(); }); ta.addEventListener('focus', function(e) { lastFocusedTextarea = e.target; }); setTimeout(() => ta.dispatchEvent(new Event('input')), 0); }
    }

    // --- Mode Toggle Logic ---
    function toggleMode() {
      const body = document.body;
      if (body.classList.contains('mode-rapid')) {
        body.classList.remove('mode-rapid');
        body.classList.add('mode-standard');
        localStorage.setItem('promptMode', 'standard');
      } else {
        body.classList.remove('mode-standard');
        body.classList.add('mode-rapid');
        localStorage.setItem('promptMode', 'rapid');
      }
    }

    // --- Rapid Fire ---
    function handleRapidKey(e) { if(e.key === 'Enter') sendRapidFire(); }
    function sendRapidFire() {
      const input = document.getElementById('rapidInput');
      const val = input.value.trim();
      if(!val) return;
      let type = 'free';
      if(val.startsWith('„Äå') || val.startsWith('„Äé')) type = 'speech';
      else if(val.startsWith('[')) type = 'code'; 
      addNewCard(type, val);
      input.value = ''; input.focus();
    }

    // --- Inline ---
    function insertAtCursor(textToInsert, wrap = false) {
      if (!lastFocusedTextarea) { alert("Select a text area first!"); return; }
      const field = lastFocusedTextarea; const startPos = field.selectionStart; const endPos = field.selectionEnd; const originalText = field.value; const selectedText = originalText.substring(startPos, endPos);
      let newText = "", newCursorPos = 0;
      if (wrap) { newText = originalText.substring(0, startPos) + textToInsert[0] + selectedText + textToInsert[1] + originalText.substring(endPos); newCursorPos = selectedText.length > 0 ? startPos + textToInsert[0].length + selectedText.length + textToInsert[1].length : startPos + textToInsert[0].length; } 
      else { newText = originalText.substring(0, startPos) + textToInsert + originalText.substring(endPos); newCursorPos = startPos + textToInsert.length; }
      field.value = newText; field.selectionStart = field.selectionEnd = newCursorPos; field.dispatchEvent(new Event('input')); field.focus();
    }
    function insertWildcard(e) { e.preventDefault(); insertAtCursor("****"); }
    function insertBracket(e) { e.preventDefault(); insertAtCursor(["[", "]"], true); }
    function insertSeparator(e) { e.preventDefault(); insertAtCursor("\n---\n"); }

    // --- Share / Export ---
    function openShareModal() { document.getElementById('shareModal').style.display = 'flex'; }
    function getAllText() { const cards = document.querySelectorAll('#streamList .card textarea'); let text = ""; cards.forEach(ta => { const val = ta.value.trim(); if(val) text += val + "\n\n"; }); return text; }
    async function shareContent(mode) { const rawText = getAllText(); const textToShare = (mode === 'code') ? "```markdown\n" + rawText + "\n```" : rawText; const title = (mode === 'code') ? "Prompt Code" : "Prompt Text"; if (navigator.share) { try { await navigator.share({ title: title, text: textToShare }); } catch (err) { if(err.name !== 'AbortError') alert("Share failed: " + err); } } else { navigator.clipboard.writeText(textToShare); alert("Web Share API not supported.\nCopied to clipboard!"); } document.getElementById('shareModal').style.display = 'none'; }
    async function shareAsFile(ext) { const text = getAllText(); const fileName = `PROMPT_${new Date().toISOString().slice(0,10)}.${ext}`; const file = new File([text], fileName, { type: 'text/plain' }); if (navigator.canShare && navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'Prompt File', text: 'Sending Prompt File...' }); } catch (err) { if(err.name !== 'AbortError') alert("File Share failed: " + err); } } else { downloadFile(ext); } document.getElementById('shareModal').style.display = 'none'; }
    function downloadFile(ext) { const text = getAllText(); const blob = new Blob([text], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `PROMPT_${new Date().toISOString().slice(0,10)}.${ext}`; a.click(); }

    // --- Parts/Char/Proj/Snip (Minified logic) ---
    function openPartModal(e) { e.preventDefault(); renderPartList(); document.getElementById('partModal').style.display = 'flex'; }
    function savePart() { const text = document.getElementById('newPartText').value; if(!text) return; const parts = JSON.parse(localStorage.getItem('promptInlineParts') || '[]'); parts.push(text); localStorage.setItem('promptInlineParts', JSON.stringify(parts)); document.getElementById('newPartText').value = ''; renderPartList(); }
    function renderPartList() { const list = document.getElementById('partList'); const parts = JSON.parse(localStorage.getItem('promptInlineParts') || '[]'); list.innerHTML = ''; parts.forEach((text, index) => { const chip = document.createElement('div'); chip.className = 'part-chip'; chip.innerHTML = `${text} <span class="del" onclick="deletePart(${index}, event)">√ó</span>`; chip.onclick = (e) => { if(!e.target.classList.contains('del')){ insertAtCursor(text); document.getElementById('partModal').style.display='none'; }}; list.appendChild(chip); }); }
    function deletePart(index, e) { e.stopPropagation(); const parts = JSON.parse(localStorage.getItem('promptInlineParts')||'[]'); parts.splice(index,1); localStorage.setItem('promptInlineParts', JSON.stringify(parts)); renderPartList(); }
    function openCharModal() { renderCharList(); document.getElementById('charModal').style.display = 'flex'; }
    function renderCharList() { const list = document.getElementById('charList'); const filter = document.getElementById('charTagFilter'); const db = JSON.parse(localStorage.getItem('promptChars') || '{}'); const tags = new Set(['ALL']); Object.values(db).forEach(obj => { if(obj.tag) tags.add(obj.tag); }); const currentVal = filter.value; filter.innerHTML = ''; tags.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.innerText = t; filter.appendChild(opt); }); if(tags.has(currentVal)) filter.value = currentVal; list.innerHTML = ''; const selectedTag = filter.value; Object.keys(db).forEach(name => { const entry = db[name]; if(selectedTag !== 'ALL' && entry.tag !== selectedTag) return; const item = document.createElement('div'); item.className = 'list-item'; item.innerHTML = `<div class="list-info"><span class="list-tag">${entry.tag||'-'}</span><span class="list-name">${name}</span></div><div class="btn-group"><button class="btn-sm btn-load" onclick="loadCharacter('${name}')">ADD</button><button class="btn-sm btn-del" onclick="deleteCharacter('${name}')">√ó</button></div>`; list.appendChild(item); }); }
    window.loadCharacter = (name) => { const db = JSON.parse(localStorage.getItem('promptChars') || '{}'); if(db[name]) { const entry = db[name]; let content = entry.text || `[AI personality: ${name}]`; if(!entry.text && entry.role) { content = `[AI personality: ${name}, role: ${entry.role}]`; } addNewCard('char_def', content); document.getElementById('charModal').style.display = 'none'; } };
    window.deleteCharacter = (name) => { if(confirm(`Delete?`)){ const db = JSON.parse(localStorage.getItem('promptChars')||'{}'); delete db[name]; localStorage.setItem('promptChars', JSON.stringify(db)); renderCharList(); }};
    function openProjectModal() { renderProjectList(); document.getElementById('projectModal').style.display = 'flex'; }
    function saveCurrentBoard() { const name = document.getElementById('saveProjName').value.trim(); const tag = document.getElementById('saveProjTag').value.trim() || "Work"; if(!name) { alert("Enter Name"); return; } const data = []; document.querySelectorAll('#streamList .card').forEach(card => data.push({ type: card.dataset.type, text: card.querySelector('textarea').value })); const db = JSON.parse(localStorage.getItem('promptProjects') || '{}'); db[name] = { items: data, tag: tag }; localStorage.setItem('promptProjects', JSON.stringify(db)); document.getElementById('saveProjName').value = ''; renderProjectList(); }
    function renderProjectList() { const list = document.getElementById('projectList'); const filter = document.getElementById('projTagFilter'); const datalist = document.getElementById('projTagList'); const db = JSON.parse(localStorage.getItem('promptProjects') || '{}'); const tags = new Set(['ALL']); const dynamicTags = new Set(); Object.values(db).forEach(obj => { if(obj.tag) { tags.add(obj.tag); dynamicTags.add(obj.tag); } }); datalist.innerHTML = ''; Array.from(dynamicTags).sort().forEach(t => { const opt = document.createElement('option'); opt.value = t; datalist.appendChild(opt); }); const currentVal = filter.value; filter.innerHTML = ''; tags.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.innerText = t; filter.appendChild(opt); }); if(tags.has(currentVal)) filter.value = currentVal; list.innerHTML = ''; const selectedTag = filter.value; Object.keys(db).forEach(name => { const entry = db[name]; if(selectedTag !== 'ALL' && entry.tag !== selectedTag) return; const item = document.createElement('div'); item.className = 'list-item'; item.innerHTML = `<div class="list-info"><span class="list-tag">${entry.tag}</span><span class="list-name">${name}</span></div><div class="btn-group"><button class="btn-sm btn-load" onclick="loadProject('${name}')">LOAD</button><button class="btn-sm btn-del" onclick="deleteProject('${name}')">DEL</button></div>`; list.appendChild(item); }); }
    window.loadProject = (name) => { if(!confirm("Load?")) return; const db = JSON.parse(localStorage.getItem('promptProjects')||'{}'); document.getElementById('streamList').innerHTML = ''; db[name].items.forEach(item => addNewCard(item.type, item.text)); document.getElementById('projectModal').style.display = 'none'; saveToLocal(); };
    window.deleteProject = (name) => { if(confirm("Delete?")){ const db = JSON.parse(localStorage.getItem('promptProjects')||'{}'); delete db[name]; localStorage.setItem('promptProjects', JSON.stringify(db)); renderProjectList(); }};
    function openSnippetModal() { renderSnippetList(); document.getElementById('snippetModal').style.display = 'flex'; }
    function saveSnippet() { const name = document.getElementById('newSnipName').value; const content = document.getElementById('newSnipContent').value; if(!name || !content) return; const db = JSON.parse(localStorage.getItem('promptSnippets') || '{}'); db[name] = content; localStorage.setItem('promptSnippets', JSON.stringify(db)); document.getElementById('newSnipName').value=''; document.getElementById('newSnipContent').value=''; renderSnippetList(); }
    function renderSnippetList() { const list = document.getElementById('snippetList'); const db = JSON.parse(localStorage.getItem('promptSnippets') || '{}'); list.innerHTML = ''; Object.keys(db).forEach(name => { const item = document.createElement('div'); item.className = 'list-item'; item.innerHTML = `<div class="list-info"><span class="list-name" style="color:var(--code-color);">${name}</span><span class="list-preview">${db[name]}</span></div><div class="btn-group"><button class="btn-sm btn-load" style="background:var(--code-color);" onclick="insertSnippet('${name}')">ADD</button><button class="btn-sm btn-del" onclick="deleteSnippet('${name}')">√ó</button></div>`; list.appendChild(item); }); }
    window.insertSnippet = (name) => { const db = JSON.parse(localStorage.getItem('promptSnippets')||'{}'); addNewCard('code', db[name]); document.getElementById('snippetModal').style.display = 'none'; };
    window.deleteSnippet = (name) => { if(confirm("Delete?")){ const db = JSON.parse(localStorage.getItem('promptSnippets')||'{}'); delete db[name]; localStorage.setItem('promptSnippets', JSON.stringify(db)); renderSnippetList(); }};

    function saveToLocal() { const data = []; document.querySelectorAll('#streamList .card').forEach(card => data.push({ type: card.dataset.type, text: card.querySelector('textarea').value })); localStorage.setItem('promptStreamMobile', JSON.stringify(data)); }
    function clearBoard() { if(confirm("Clear board?")) { document.getElementById('streamList').innerHTML = '<p style="text-align:center; color:var(--border-color); font-size:12px; margin-top:50px;">TAP PALETTE TO START</p>'; saveToLocal(); } }
    
    // On Load
    window.onload = function() {
      // Restore Mode
      const savedMode = localStorage.getItem('promptMode') || 'rapid';
      const body = document.body;
      body.classList.remove('mode-rapid', 'mode-standard');
      body.classList.add(`mode-${savedMode}`);

      // Restore Data
      const saved = localStorage.getItem('promptStreamMobile');
      if (saved) {
        const data = JSON.parse(saved);
        if(data.length > 0) {
          document.getElementById('streamList').innerHTML = '';
          data.forEach(item => addNewCard(item.type, item.text));
        }
      }
    };
  </script>
</body>
</html>
