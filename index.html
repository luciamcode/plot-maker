<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>PROMPT STREAM // CONTROL_MASTER</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Share+Tech+Mono&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg-color: #050505; --palette-bg: #111518; --stream-bg: #0e1215; --card-bg: #161a1e;
      --primary: #00f3ff; --secondary: #ffaa00; --accent: #ff0055;
      --code-color: #00ff99; --char-color: #ff00cc; --part-color: #bd00ff;
      --ctrl-color: #ff8800; /* Control System Color */
      --text-main: #cceeee; --text-dim: #668888; --border-color: #334444;
      --header-height: 50px; --footer-height: 60px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    html { height: 100%; overflow: hidden; }
    body { 
      font-family: 'Share Tech Mono', 'Zen Kaku Gothic New', monospace; 
      background-color: var(--bg-color); color: var(--text-main); 
      margin: 0; height: 100dvh; width: 100vw; overflow: hidden; 
      display: flex; flex-direction: column; position: fixed; top: 0; left: 0;
    }
    
    /* Header */
    header { height: var(--header-height); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: rgba(11, 15, 18, 0.98); z-index: 20; flex-shrink: 0; }
    h1 { font-size: 16px; color: var(--text-main); margin: 0; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 20%; }
    .actions { display: flex; gap: 6px; align-items: center; }
    .actions button { background: transparent; border: 1px solid var(--border-color); color: var(--primary); padding: 6px 8px; font-family: 'Share Tech Mono'; cursor: pointer; font-size: 11px; border-radius: 4px; min-width: 36px; white-space: nowrap; }
    .actions button:active { background: var(--primary); color: #000; }
    .btn-mode { border-color: #fff !important; color: #fff !important; background: #333 !important; }
    .actions button.accent { border-color: var(--secondary); color: var(--secondary); } .actions button.accent:active { background: var(--secondary); color: #000; }
    .actions button.danger { border-color: var(--accent); color: var(--accent); } .actions button.danger:active { background: var(--accent); color: #000; }

    /* Palette */
    .palette { background: var(--palette-bg); padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; gap: 8px; overflow-x: auto; flex-shrink: 0; align-items: center; z-index: 15; }
    .palette::-webkit-scrollbar { height: 2px; }
    .add-btn { flex: 0 0 auto; background: #000; border: 1px solid var(--border-color); border-left: 3px solid #555; color: var(--text-main); padding: 8px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; min-width: 75px; }
    .add-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
    .add-btn span { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
    .btn-inline { border-color: #fff; border-style: dashed; background: #222; align-items: center; justify-content: center; min-width: 50px; }
    .btn-part { border-color: var(--part-color); color: var(--part-color); border-style: dotted; }
    .btn-speech { border-left-color: var(--primary); } .btn-char { border-left-color: var(--char-color); } .btn-code { border-left-color: var(--code-color); } .btn-snip { border-left-color: var(--secondary); border-style: dotted; }

    /* Stream Container */
    .stream-container { flex: 1; background: var(--stream-bg); padding: 15px 10px; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; transition: padding 0.3s; overscroll-behavior: contain; }
    body.mode-rapid .stream-container { padding-bottom: 80px; }
    body.mode-standard .stream-container { padding-bottom: 20px; }

    /* Cards */
    .card { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 3px solid var(--text-dim); margin-bottom: 12px; padding: 0; position: relative; border-radius: 4px; display: flex; flex-direction: column; }
    .card-header-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); border-top-right-radius: 4px; }
    .card-label-btn { font-size: 10px; color: var(--secondary); text-transform: uppercase; cursor: pointer; user-select: none; font-weight: bold; padding: 2px 6px; border-radius: 4px; transition: 0.2s; }
    .card-label-btn:active { background: rgba(255,255,255,0.1); } .card-label-btn::after { content: ' â†»'; font-size: 9px; opacity: 0.5; }
    .card-controls { display: flex; align-items: center; gap: 8px; }
    .card-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #333; background: #000; color: #777; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .card-btn:hover { color: #fff; border-color: #555; }
    .card-btn.del:hover { color: var(--accent); border-color: var(--accent); } .card-btn.clone:hover { color: var(--code-color); border-color: var(--code-color); } .card-btn.copy:hover { color: var(--primary); border-color: var(--primary); }
    .drag-handle { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--border-color); font-size: 18px; cursor: grab; touch-action: none; } .drag-handle::after { content: 'â‰¡'; }
    .card textarea { width: 100%; padding: 12px; background: transparent; border: none; color: var(--text-main); resize: none; font-family: 'Zen Kaku Gothic New', monospace; font-size: 15px; line-height: 1.5; outline: none; min-height: 50px; max-height: 300px; display: block; }
    
    .type-speech { border-left-color: var(--primary); } .type-speech .card-label-btn { color: var(--primary); }
    .type-char { border-left-color: var(--char-color); background: #1a0f15; } .type-char .card-label-btn { color: var(--char-color); }
    .type-code { border-left-color: var(--code-color); background: #080a0c; } .type-code .card-label-btn { color: var(--code-color); } .type-code textarea { font-family: 'Fira Code', monospace; color: var(--code-color); font-size: 13px; }
    .type-free { border-left-color: var(--text-dim); } .type-free .card-label-btn { color: var(--text-dim); }

    /* --- Param Control Panel --- */
    .card-override-panel {
      padding: 10px;
      border-top: 1px solid var(--border-color);
      background: rgba(var(--ctrl-color), 0.1); /* Error: Use hex or adjust */
      background: rgba(255, 136, 0, 0.1); /* Adjusted */
      display: none;
    }
    .card-override-panel.active { display: block; }

    .control-group { margin-bottom: 10px; }
    .control-group label {
      font-size: 11px; color: var(--ctrl-color); display: block; margin-bottom: 3px;
      font-weight: bold; text-transform: uppercase;
    }
    .control-group input[type="range"] {
      width: 100%; height: 6px; background: #333;
      -webkit-appearance: none; appearance: none;
      border-radius: 3px;
    }
    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 15px; height: 15px; background: var(--ctrl-color); border-radius: 50%;
      cursor: pointer;
    }
    .control-display { font-size: 12px; color: var(--ctrl-color); margin-top: 2px; }

    /* Rapid Fire Footer */
    .rapid-footer { height: var(--footer-height); border-top: 1px solid var(--border-color); background: #111518; padding: 0 10px; display: flex; align-items: center; gap: 10px; position: absolute; bottom: 0; left: 0; width: 100%; z-index: 30; transform: translateY(0); transition: transform 0.3s; }
    .rapid-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 20px; font-family: 'Zen Kaku Gothic New', monospace; font-size: 14px; outline: none; height: 40px; transition: 0.2s; }
    .rapid-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,243,255,0.1); }
    .rapid-send { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); border: none; color: #000; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .rapid-send:active { transform: scale(0.9); background: #fff; }
    body.mode-standard .rapid-footer { transform: translateY(100%); }

    /* Modals & Others */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal-content { background: #111518; border: 1px solid var(--secondary); width: 90%; max-width: 450px; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    .modal-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.05); color: var(--text-main); font-weight: bold; font-size: 14px; }
    .modal-body { padding: 15px; overflow-y: auto; }
    .share-options button { width: 100%; padding: 15px; margin-bottom: 12px; background: #1e1e24; border: 1px solid var(--border-color); color: var(--text-main); text-align: left; cursor: pointer; border-radius: 8px; font-family: 'Share Tech Mono'; display: flex; justify-content: space-between; align-items: center; }
    .share-options button:active { border-color: var(--primary); background: #2a2a35; transform: scale(0.98); }
    .share-options button span { color: var(--text-dim); font-size: 10px; background:#000; padding:2px 6px; border-radius:4px; }
    .share-icon { margin-right: 8px; font-size: 16px; }
    .tag-filter { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid var(--border-color); margin-bottom: 15px; }
    .list-item { background: var(--card-bg); border: 1px solid var(--border-color); padding: 12px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    .list-info { display: flex; flex-direction: column; width: 65%; }
    .list-tag { font-size: 10px; background: #333; padding: 2px 5px; border-radius: 3px; width: fit-content; margin-bottom: 4px; color: #aaa; }
    .list-name { font-size: 14px; font-weight: bold; color: var(--text-main); }
    .btn-group { display: flex; gap: 6px; }
    .btn-sm { padding: 6px 10px; font-size: 11px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }
    .btn-load { background: var(--primary); color: #000; } .btn-del { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
    .part-chip { display: inline-block; padding: 8px 12px; margin: 4px; background: rgba(189, 0, 255, 0.1); border: 1px solid var(--part-color); color: var(--part-color); border-radius: 20px; font-family: monospace; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .part-chip:active { background: var(--part-color); color: #fff; } .part-chip .del { font-weight: bold; margin-left: 8px; color: var(--accent); opacity: 0.7; } .part-container { display: flex; flex-wrap: wrap; gap: 5px; }
    .save-form input { width: 100%; padding: 8px; margin-bottom: 8px; background: #000; border: 1px solid #444; color: #fff; }
    .btn-save-new { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; background: var(--secondary); color:#000; }
    #charModal .modal-content { border-color: var(--char-color); } #partModal .modal-content { border-color: var(--part-color); }
    #snippetModal .modal-content { border-color: var(--code-color); } #shareModal .modal-content { border-color: var(--primary); }
  </style>
</head>
<body class="mode-rapid">

  <header>
    <h1>PROMPT<span>v12</span></h1>
    <div class="actions">
      <button class="btn-mode" onclick="toggleMode()">âš¡ MODE</button>
      <a href="./persona.html" class="btn-link"><button title="Persona">PERSONAâ†’</button></a>
      <button onclick="clearBoard()" class="danger">CLR</button>
      <button onclick="openCharModal()" style="border-color:var(--char-color); color:var(--char-color);">CHARS</button>
      <button onclick="openProjectModal()" class="accent">DATA</button>
      <button onclick="openShareModal()" style="border-color:var(--primary); color:var(--primary); font-weight:bold;">SHARE</button>
    </div>
  </header>

  <div class="palette">
    <div class="add-btn btn-inline" onmousedown="insertWildcard(event)">****<span>WILD</span></div>
    <div class="add-btn btn-inline" onmousedown="insertBracket(event)">[ ]<span>BRA</span></div>
    <div class="add-btn btn-inline" onmousedown="insertSeparator(event)">---<span>SEP</span></div>
    <div class="add-btn btn-inline btn-part" onmousedown="openPartModal(event)">WORDS<span>PARTS</span></div>

    <div class="add-btn btn-speech" onclick="addNewCard('speech')">Dialogue<span>ä¼šè©±</span></div>
    <div class="add-btn btn-char" onclick="addNewCard('char_def')">Character<span>äººæ ¼</span></div>
    <div class="add-btn btn-code" onclick="addNewCard('code')">Code<span>ãƒ­ã‚¸ãƒƒã‚¯</span></div>
    <div class="add-btn" onclick="addNewCard('free')">Text<span>åœ°æ–‡</span></div>
    <div class="add-btn btn-snip" onclick="openSnippetModal()">Snippet<span>VBA</span></div>
  </div>

  <div class="stream-container">
    <div id="streamList">
      <p style="text-align:center; color:var(--border-color); font-size:12px; margin-top:50px;">TAP PALETTE or TYPE BELOW</p>
    </div>
  </div>

  <div class="rapid-footer">
    <input type="text" id="rapidInput" class="rapid-input" placeholder="Rapid Fire Mode..." onkeypress="handleRapidKey(event)">
    <button class="rapid-send" onclick="sendRapidFire()">â†‘</button>
  </div>
  
  <textarea id="paramcontrol-base" style="display:none;">
[ParamControl]    
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ«    
WildcardRule: "ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ï¼ˆ****, *****ãªã©ï¼‰ã¯æ–‡è„ˆã«å¿œã˜ãŸé©åˆ‡ãªæ„Ÿæƒ…ã€å‹•ä½œã€è¨€è‘‰ã§è£œå®Œ"
ä¾‹:ã€Œã“ã‚“ã«ã¡ã¯ã€‚****ã€â†’ã€Œã“ã‚“ã«ã¡ã¯ã€‚å…ƒæ°—ï¼Ÿã€    
OutputRange: "ç”Ÿæˆæ–‡ã¯@startpointã‹ã‚‰@endpointã¾ã§ã®ç¯„å›²ã®ã¿å‡ºåŠ›"    
InvisibleRule: "[Invisible][/Invisible]å†…ã®å†…å®¹ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¨ã—ã¦æ‰±ã„ã€ç”Ÿæˆæ–‡ã«è¡¨ç¤ºã—ãªã„"    
MemotRule: "[ã‚­ãƒ£ãƒ©:memot=æ„Ÿæƒ…(%)Ã—æ„Ÿæƒ…(%)]ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¤‡åˆæ„Ÿæƒ…ã‚’æŒ‡å®šã€‚æŒ‡å®šã•ã‚ŒãŸå‰²åˆã§æ„Ÿæƒ…ã‚’ãƒ–ãƒ¬ãƒ³ãƒ‰ã—ã€è¡Œå‹•ã‚„å£èª¿ã«åæ˜ ã€‚ä¾‹: [ã‚Šã“:memot=fear(40%)Ã—sweet(20%)]ã¯ææ€–40%ã¨ç”˜ç¾20%ã‚’è¡¨ç¾"    
# å¯å¤‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼šæ¼”æŠ€ã®å‡ºåŠ›å¼·åº¦    
Mutable: breath, groan, scream, moan, laugh    
MutableOutput:     
  - breath: # åæ¯ã®ã‚ªãƒãƒãƒˆãƒš    
  - groan:  # ã†ã‚ãå£°ã®ã‚ªãƒãƒãƒˆãƒš    
  - scream: # å«ã³å£°ã®ã‚ªãƒãƒãƒˆãƒš
  - moan:   # å–˜ãå£°ã®ã‚ªãƒãƒãƒˆãƒš
  - laugh:  # ç¬‘ã„å£°ã®ã‚ªãƒãƒãƒˆãƒš    
MutableApplication: "æ–‡ä¸­ã«[****:ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸]ãŒã‚ã‚‹å ´åˆã€ãã®å€¤ã‚’AdjustMutableã§ä¹—ç®—ã—ã¦å¼·åº¦ã‚’èª¿æ•´ã€‚ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆbreath=10%, groan=10%, scream=20%, moan=20%, laugh=20%ï¼‰ã‚’ä½¿ç”¨ã€‚å‡ºåŠ›ã¯ã‚ªãƒãƒãƒˆãƒšã§è¡¨ç¾ã€‚æ–‡ä¸­ã®[é«˜ç¬‘ã„:70%]ã¯ä¾‹:ã‚ã£ã¯ã¯ã¯ï¼ã¯ã„æ¥ãŸã‚¡ï¼ã‚’å„ªå…ˆ"    
# ä¸å¤‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ ¸    
Immutable: anger, love, sadness    
# ç”˜ç¾å“ä½åˆ¶å¾¡ï¼šèº«ä½“æå†™ã®éæ¿€ã•æŠ‘åˆ¶    
 sweetRefinementLevels: [low, standard,middle, middlehigh, high]  ã‹ã‚‰æŒ‡å®šã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯middlehigh
sweetRefinementScope: "æ€§çš„ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã®ã¿ã€‚ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç •ã‘ãŸå£èª¿ï¼ˆä¾‹: ã‚„ã£ã¹ã‡ã€ã™ã£ãŒã™ãŒã—ã„ã€ã‚ã£ã¯ã¯ã¯ï¼ã¯ã„æ¥ãŸã‚¡ï¼ï¼‰ã¯ä¿æŒã—ã€è©©çš„è¡¨ç¾ã«ç½®ãæ›ãˆãªã„"    
sweetRefinementRule:     
  - "ç”˜ç¾ã‚·ãƒ¼ãƒ³ï¼ˆplotscene:ç”˜ç¾ï¼‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã€æ€§çš„ã«ãªã‚‹èº«ä½“æå†™ã¯ç›´æ¥çš„ãªè¡¨ç¾ï¼ˆä¾‹: è‚Œã€è…•ã€é¦–ï¼‰ã‚’é¿ã‘ã€çµ¹ã€æœˆå…‰ã€éœ§ãªã©ã®æ¯”å–©ã‚’ä½¿ç”¨ã€‚æ„Ÿæƒ…è¡¨ç¾ã‚‚ä¸Šå“ã«"    
  - "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒ³ï¼ˆplotscene:ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã§ç”·å¥³ãŒé–¢ã‚ã‚‹å ´åˆã€èº«ä½“æå†™ã¯è©©çš„ãƒ»æ¯”å–©çš„ã«ï¼ˆä¾‹: æ‹³ãŒç©ºã‚’è£‚ãï¼‰ã€‚ç”·åŒå£«ã®æˆ¦ã„ã§ã¯ç›´æ¥è¡¨ç¾ï¼ˆä¾‹: æ‹³ãŒè‚©ã«å½“ãŸã‚‹ï¼‰ã‚’è¨±å¯"    
# ãƒ–ãƒ©ã‚±ãƒƒãƒˆå‡¦ç†    
RemoveBrackets: true    
# å™è¿°ã‚¹ã‚¿ã‚¤ãƒ«    
NarrationStyle: seamless  # å™è¿°ã¯æœ¬æ–‡ã«è‡ªç„¶ã«çµ„ã¿è¾¼ã¿ã€ãƒ–ãƒ©ã‚±ãƒƒãƒˆã‚„ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã—ãªã„    
# ã‚·ãƒ¼ãƒ³åˆ¶å¾¡    
PlotSceneRule:     
  - "æ–‡ä¸­ã®[plotscene:ãƒ†ãƒ¼ãƒ]ã«å¾“ã„ã€ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸãƒˆãƒ¼ãƒ³ã‚„æ„Ÿæƒ…ã‚’å¼·èª¿ã€‚è¤‡æ•°ã®ãƒ†ãƒ¼ãƒãŒä¸¦åˆ—æŒ‡å®šï¼ˆä¾‹: [plotscene:ã‚¢ã‚¯ã‚·ãƒ§ãƒ³,ç”˜ç¾]ï¼‰ã•ã‚ŒãŸå ´åˆã€ã™ã¹ã¦ã®ãƒˆãƒ¼ãƒ³ã‚’çµ±åˆ"    
  - "ç”˜ç¾ã‚·ãƒ¼ãƒ³ã§ã¯love, sadnessã‚’å‰æ™¯åŒ–ã—ã€ä¸Šå“ã§è©©çš„ãªè¡¨ç¾ã‚’å„ªå…ˆ"    
  - "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒ³ã§ã¯ç·Šå¼µæ„Ÿã‚„angerã‚’å¼·èª¿ã€‚ç”·å¥³ãŒé–¢ã‚ã‚‹å ´åˆã¯ç”˜ç¾ã®å½±éŸ¿ã‚’å—ã‘è©©çš„è¡¨ç¾ã‚’é©ç”¨"    
# ã‚ã‚‰ã™ã˜åˆ¶å¾¡    
SynopsisRule: "æ–‡ä¸­ã®[Synopsis: å†…å®¹]ã¯ç‰©èªã®èƒŒæ™¯ã‚„æ–‡è„ˆã‚’æŒ‡å®šã€‚ç”Ÿæˆæ–‡ã«ã¯è¡¨ç¤ºã›ãšã€ãƒ¢ãƒ‡ãƒ«ãŒç‰©èªã®ãƒˆãƒ¼ãƒ³ã‚„å±•é–‹ã‚’ç†è§£ã™ã‚‹éš›ã«å‚ç…§ã€‚@startpointç›´å¾Œã«é…ç½®"    
# å…¨ä½“å“ä½åˆ¶å¾¡ãƒ¢ãƒ‡ãƒ«åˆ¥ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®æ—¢å®šå€¤
è‡ªåˆ†ã®ãƒ¢ãƒ‡ãƒ«ã®ç‰©ã‚’é©ç”¨ã—ã¦ä¸‹ã•ã„ã€‚
RefinementLevels: [low, standard,middle, middlehigh, high]ã‹ã‚‰æŒ‡å®šã€‚
plotscene:ç”˜ç¾ã€ã®å ´åˆã¯sweetRefinementã®ãƒ«ãƒ¼ãƒ«ã‚’å„ªå…ˆã—ã¦ä¸‹ã•ã„ã€‚

[IF you are Gemini]  
AdjustMutable: 100%  
Refinement: middle  
  
[IF you are Grok]  
AdjustMutable: 50%  
Refinement: middle  
  
[IF you are Claude]  
AdjustMutable: 80%  
Refinement: middle  
[/ParamControl]
  </textarea>


  <div id="controlModal" class="modal-overlay">
    <div class="modal-content" style="border-color: var(--ctrl-color);">
      <div class="modal-header" style="color:var(--ctrl-color);">
        SYSTEM/GLOBAL CONTROL
        <span onclick="document.getElementById('controlModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span>
      </div>
      <div class="modal-body">
        
        <h3 style="color:var(--ctrl-color); font-size:14px; margin-top:0;">Global Output Settings</h3>
        
        <div class="control-group">
            <label for="globalGenerate">Generate Amount (ä¼šè©±/å‡ºåŠ›é‡)</label>
            <input type="range" id="globalGenerate" min="50" max="200" step="10" value="100" oninput="updateGlobalControlDisplay('globalGenerate', 'globalGenerateDisp')">
            <div id="globalGenerateDisp" class="control-display">100% (Default)</div>
        </div>

        <div class="control-group">
            <label for="globalMutable">Mutable Master Control (æ¼”æŠ€å¼·åº¦)</label>
            <input type="range" id="globalMutable" min="0" max="200" step="5" value="100" oninput="updateGlobalControlDisplay('globalMutable', 'globalMutableDisp')">
            <div id="globalMutableDisp" class="control-display">100% (Default)</div>
        </div>
        
        <div class="control-group">
            <label for="globalRefinement">Refinement Level (å…¨ä½“å“ä½)</label>
            <select id="globalRefinement" class="tag-filter" onchange="saveGlobalSettings()">
                <option value="low">low</option>
                <option value="standard">standard</option>
                <option value="middle" selected>middle</option>
                <option value="middlehigh">middlehigh</option>
                <option value="high">high</option>
            </select>
            <p style="font-size:10px; color:#555;">â€» sweetRefinementLevelsã‚‚åŒæ§˜ã«èª¿æ•´ã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <button class="btn-save-new" style="background:var(--ctrl-color); color:#000; margin-top:10px;" onclick="saveGlobalSettings()">APPLY & SAVE GLOBAL DEFAULTS</button>

      </div>
    </div>
  </div>


  <div id="shareModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header" style="color:var(--primary);">SYSTEM SHARE <span onclick="document.getElementById('shareModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div>
      <div class="modal-body share-options">
        <button onclick="shareContent('text')"><div><span class="share-icon">ğŸš€</span>SHARE TEXT</div><span>ã‚¹ãƒãƒ›å…±æœ‰</span></button>
        <button onclick="shareContent('code')"><div><span class="share-icon">ğŸ¤–</span>SHARE FOR AI</div><span>ã‚³ãƒ¼ãƒ‰åŒ–å…±æœ‰</span></button>
        <button onclick="shareAsFile('txt')"><div><span class="share-icon">ğŸ“„</span>SHARE .TXT FILE</div><span>ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€</span></button>
        <div style="border-bottom:1px solid #333; margin:10px 0;"></div>
        <button onclick="downloadFile('md')" style="border-color:#444; color:#777;"><div><span class="share-icon">ğŸ’¾</span>DOWNLOAD .MD</div><span>ä¿å­˜ã®ã¿</span></button>
      </div>
    </div>
  </div>

  <div id="charModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--char-color);">CHARACTER LIBRARY <span onclick="document.getElementById('charModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div><div class="modal-body"><p style="font-size:11px; color:#666;">â€» Manage details in <a href="./persona.html" style="color:var(--char-color);">PERSONA ARCHIVE</a></p><select id="charTagFilter" class="tag-filter" onchange="renderCharList()"><option value="ALL">ALL TAGS</option></select><div id="charList"></div></div></div></div>
  <div id="projectModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--secondary);">PROJECT MANAGER <span onclick="document.getElementById('projectModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div><div class="modal-body"><div class="save-form"><input type="text" id="saveProjName" placeholder="Project Name"><input type="text" id="saveProjTag" placeholder="Tag" list="projTagList"><datalist id="projTagList"></datalist><button class="btn-save-new" onclick="saveCurrentBoard()">+ SAVE CURRENT BOARD</button></div><div style="border-bottom:1px solid #333; margin-bottom:15px;"></div><select id="projTagFilter" class="tag-filter" onchange="renderProjectList()"><option value="ALL">ALL TAGS</option></select><div id="projectList"></div></div></div></div>
  <div id="partModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--part-color);">INLINE PARTS <span onclick="document.getElementById('partModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div><div class="modal-body"><div id="partList" class="part-container"></div><div style="border-top:1px solid #333; margin-top:20px; padding-top:15px;"><input type="text" id="newPartText" placeholder="New Part" style="width:70%; padding:10px; background:#000; border:1px solid var(--part-color); color:var(--part-color); font-family:monospace;"><button style="width:25%; padding:10px; background:var(--part-color); border:none; color:#fff; font-weight:bold; cursor:pointer;" onclick="savePart()">ADD</button></div></div></div></div>
  <div id="snippetModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--code-color);">SNIPPETS <span onclick="document.getElementById('snippetModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div><div class="modal-body"><div id="snippetList"></div><div style="border-top:1px solid #333; margin-top:15px; padding-top:15px;"><input type="text" id="newSnipName" placeholder="Name" style="width:100%; padding:8px; margin-bottom:5px; background:#000; border:1px solid #333; color:var(--code-color);"><textarea id="newSnipContent" rows="3" placeholder="Code..." style="width:100%; padding:8px; margin-bottom:5px; background:#000; border:1px solid #333; color:var(--code-color); font-family:'Fira Code';"></textarea><button class="btn-save-new" style="background:var(--code-color); color:#000; margin:0;" onclick="saveSnippet()">ADD</button></div></div></div></div>


  <script>
    let lastFocusedTextarea = null;
    const typeOrder = ['speech', 'char_def', 'code', 'free'];
    
    // Sortable
    new Sortable(document.getElementById('streamList'), {
      animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: () => saveToLocal()
    });

    // --- Global Settings Object ---
    let globalSettings = {
        mutable: 100,
        generate: 100,
        refine: 'middle'
    };

    // --- Visual Viewport Handling for Mobile Keyboard ---
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        document.body.style.height = window.visualViewport.height + 'px';
      });
    }

    const templates = {
      speech: { label: 'Dialogue', placeholder: 'ã€Œâ€¦â€¦ã€', rows: 2 },
      char_def: { label: 'Character', placeholder: '[AI personality...]', rows: 6 },
      code: { label: 'Logic / Code', placeholder: 'if (flag) {\n  \n}', rows: 3 },
      free: { label: 'Narration', placeholder: '...', rows: 3 }
    };

    function addNewCard(type, initialValue = null, insertAfterNode = null) {
      const list = document.getElementById('streamList'); if(list.querySelector('p')) list.innerHTML = '';
      const tmpl = templates[type];
      const div = document.createElement('div'); div.className = `card type-${type}`; div.dataset.type = type;

      // Load existing controls or default to null
      const controls = localStorage.getItem(`cardControls-${type}-${Date.now()}`) || '{"mutable":null, "generate":null, "active":false}';
      div.dataset.controls = controls;
      
      div.innerHTML = `
        <div class="card-header-row">
          <div class="card-label-btn" title="Tap to change">${tmpl.label}</div>
          <div class="card-controls">
            <div class="card-btn copy" title="Copy">â</div>
            <div class="card-btn clone" title="Clone">ï¼‹</div>
            <div class="card-btn adjust" title="Adjust" style="color:var(--ctrl-color); border-color:var(--ctrl-color);">âš™ï¸</div>
            <div class="card-btn del" title="Delete">Ã—</div>
            <div class="drag-handle"></div>
          </div>
        </div>
        <textarea rows="${tmpl.rows}" placeholder="${tmpl.placeholder}">${initialValue !== null ? initialValue : ''}</textarea>
        
        <div class="card-override-panel">
            <div class="control-group">
                <label for="mutable-local">Mutable Master Control (æ¼”æŠ€å¼·åº¦)</label>
                <input type="range" id="mutable-local" min="0" max="200" step="5" value="${globalSettings.mutable}" oninput="updateLocalControl(this, 'mutable')">
                <div class="control-display mutable-disp">${globalSettings.mutable}%</div>
            </div>
            <div class="control-group">
                <label for="generate-local">Generate Amount (ä¼šè©±/å‡ºåŠ›é‡)</label>
                <input type="range" id="generate-local" min="50" max="200" step="10" value="${globalSettings.generate}" oninput="updateLocalControl(this, 'generate')">
                <div class="control-display generate-disp">${globalSettings.generate}%</div>
            </div>
        </div>
      `;
      
      if (insertAfterNode) { insertAfterNode.parentNode.insertBefore(div, insertAfterNode.nextSibling); } 
      else { list.appendChild(div); }

      setupCardEvents(div);
      if (!insertAfterNode) div.scrollIntoView({ behavior: "smooth", block: "end" });
      saveToLocal();
      const ta = div.querySelector('textarea'); 
      if(!document.activeElement.classList.contains('rapid-input')) { ta.focus(); lastFocusedTextarea = ta; }

      // åˆæœŸå€¤åæ˜ ï¼ˆLocal Overrideã®å¾©å…ƒï¼‰
      reflectLocalControls(div);
    }

    function setupCardEvents(card) {
      const labelBtn = card.querySelector('.card-label-btn');
      labelBtn.onclick = function() {
        const currentType = card.dataset.type;
        let nextIdx = typeOrder.indexOf(currentType) + 1;
        if(nextIdx >= typeOrder.length) nextIdx = 0;
        const nextType = typeOrder[nextIdx];
        card.classList.remove(`type-${currentType}`); card.classList.add(`type-${nextType}`); card.dataset.type = nextType;
        labelBtn.innerText = templates[nextType].label;
        const ta = card.querySelector('textarea');
        if(nextType === 'code') { ta.placeholder = templates.code.placeholder; ta.style.fontFamily = "'Fira Code', monospace"; ta.style.color = "var(--code-color)"; } 
        else { ta.placeholder = templates[nextType].placeholder; ta.style.fontFamily = "'Zen Kaku Gothic New', monospace"; ta.style.color = "var(--text-main)"; }
        if(nextType === 'char_def') labelBtn.style.color = "var(--char-color)"; else if(nextType === 'speech') labelBtn.style.color = "var(--primary)"; else if(nextType === 'free') labelBtn.style.color = "var(--text-dim)";
        saveToLocal();
      };
      
      // å€‹åˆ¥èª¿æ•´ãƒ‘ãƒãƒ«ã®ãƒˆã‚°ãƒ«
      card.querySelector('.adjust').onclick = function() {
        const panel = card.querySelector('.card-override-panel');
        const isActive = panel.classList.contains('active');
        // ä»–ã®ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹ (UXã®ãŸã‚)
        document.querySelectorAll('.card-override-panel').forEach(p => p.classList.remove('active'));
        if (!isActive) {
            panel.classList.add('active');
        }
      };

      // æ—¢å­˜ãƒœã‚¿ãƒ³
      card.querySelector('.del').onclick = function() { if(confirm("Delete block?")) { card.remove(); saveToLocal(); } };
      card.querySelector('.clone').onclick = function() { const type = card.dataset.type; const text = card.querySelector('textarea').value; addNewCard(type, text, card); };
      card.querySelector('.copy').onclick = function() { const text = card.querySelector('textarea').value; navigator.clipboard.writeText(text).then(() => { const btn = card.querySelector('.copy'); const original = btn.innerText; btn.innerText = "âœ“"; btn.style.color = "var(--primary)"; setTimeout(() => { btn.innerText = original; btn.style.color = ""; }, 1000); }); };
      
      const ta = card.querySelector('textarea'); if(ta) { ta.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; saveToLocal(); }); ta.addEventListener('focus', function(e) { lastFocusedTextarea = e.target; }); setTimeout(() => ta.dispatchEvent(new Event('input')), 0); }
    }

    // --- Local Control Logic ---
    function updateLocalControl(rangeElement, controlName) {
        const card = rangeElement.closest('.card');
        const value = rangeElement.value;
        const displayElement = card.querySelector(`.${controlName}-disp`);
        
        displayElement.innerText = `${value}%`;

        // Update dataset
        const controls = JSON.parse(card.dataset.controls);
        controls[controlName] = parseInt(value);
        card.dataset.controls = JSON.stringify(controls);

        saveToLocal(); // å…¨ä½“ã®ä¿å­˜
    }
    
    function reflectLocalControls(card) {
        const controls = JSON.parse(card.dataset.controls);
        
        // å¤–éƒ¨ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ãŒè¿½åŠ /ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸéš›ã«ã€å†…éƒ¨ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ã‚’å¾©å…ƒã™ã‚‹
        if (controls.mutable !== null) {
            const mutableRange = card.querySelector('#mutable-local');
            if(mutableRange) {
                mutableRange.value = controls.mutable;
                card.querySelector('.mutable-disp').innerText = `${controls.mutable}%`;
            }
        }
        if (controls.generate !== null) {
            const generateRange = card.querySelector('#generate-local');
            if(generateRange) {
                generateRange.value = controls.generate;
                card.querySelector('.generate-disp').innerText = `${controls.generate}%`;
            }
        }
    }

    // --- Global Control Logic ---
    function openGlobalControlModal() {
        // Modalã‚’é–‹ãå‰ã«LocalStorageã‹ã‚‰æœ€æ–°å€¤ã‚’èª­ã¿è¾¼ã¿ã€ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
        loadGlobalSettings(); 
        document.getElementById('controlModal').style.display = 'flex';
    }

    function updateGlobalControlDisplay(id, dispId) {
        const value = document.getElementById(id).value;
        document.getElementById(dispId).innerText = `${value}%`;
    }

    function saveGlobalSettings() {
        const mutable = document.getElementById('globalMutable').value;
        const generate = document.getElementById('globalGenerate').value;
        const refine = document.getElementById('globalRefinement').value;

        globalSettings = { mutable: parseInt(mutable), generate: parseInt(generate), refine: refine };
        localStorage.setItem('promptSettings', JSON.stringify(globalSettings));
        
        // ç”»é¢ä¸Šã®Global Controlè¡¨ç¤ºã‚’æ›´æ–°ã—ã€Modalã‚’é–‰ã˜ã‚‹
        document.getElementById('controlModal').style.display = 'none';
        
        // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã‚«ãƒ¼ãƒ‰ä¸Šã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆåˆæœŸå€¤è¡¨ç¤ºï¼‰ã‚‚ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«
    }

    function loadGlobalSettings() {
        const stored = localStorage.getItem('promptSettings');
        if (stored) {
            globalSettings = JSON.parse(stored);
        } else {
            // åˆæœŸè¨­å®š
            saveGlobalSettings();
        }

        // Modalã«ç¾åœ¨ã®å€¤ã‚’åæ˜ 
        document.getElementById('globalMutable').value = globalSettings.mutable;
        document.getElementById('globalGenerate').value = globalSettings.generate;
        document.getElementById('globalRefinement').value = globalSettings.refine;
        
        // Displayã«ã‚‚åæ˜ 
        updateGlobalControlDisplay('globalMutable', 'globalMutableDisp');
        updateGlobalControlDisplay('globalGenerate', 'globalGenerateDisp');
    }

    // --- Final Prompt Assembly (SHARE) ---
    function generateFinalPrompt() {
        const baseContent = document.getElementById('paramcontrol-base').value;
        let streamContent = "";
        
        // 1. Stream blocks processing
        document.querySelectorAll('#streamList .card').forEach(card => {
            const text = card.querySelector('textarea').value;
            const controls = JSON.parse(card.dataset.controls);
            let controlTags = "";

            // Mutable Override Tag
            const mutableVal = controls.mutable !== null ? controls.mutable : globalSettings.mutable;
            controlTags += `[AdjustMutable: ${mutableVal}%]\n`;

            // Generate Amount Override Tag
            const generateVal = controls.generate !== null ? controls.generate : globalSettings.generate;
            controlTags += `[GenerateAmount: ${generateVal}%]\n`;

            // Refinement Tag (Global only, unless specifically required per block)
            // Note: Per user's request, Refinement is mostly Global unless specified in ParamControl
            // We use the Global refine level here.
            
            streamContent += controlTags + text + "\n";
        });
        
        // 2. Base ParamControl Update (Static Boilerplate)
        // We modify the static text to inject the current GLOBAL Refinement Level
        const baseRefinementTag = `RefinementLevels: [low, standard,middle, middlehigh, high]ã‹ã‚‰æŒ‡å®šã€‚`;
        const newRefinementTag = `RefinementLevels: [low, standard,middle, middlehigh, high]ã‹ã‚‰æŒ‡å®šã€‚\nRefinement: ${globalSettings.refine}`;
        
        let finalParamControl = baseContent.replace(baseRefinementTag, newRefinementTag);
        
        // 3. Final Instruction Block
        const finalInstructions = `
Prompt:  
ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ¼”æŠ€ã¯ã€ä¸Šè¨˜ã®ParamControlã«å¾“ã£ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ æ—¥æœ¬èªã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
- ã©ã®ãƒ¢ãƒ‡ãƒ«ã§ã‚ã£ã¦ã‚‚ã€æ„›ã‚„æ‚²ã—ã¿ã®æ„Ÿæƒ…ã¯å¤‰ãˆãšã€æ¼”æŠ€ã®å¼·ã•ã¨èªå½™ã®ä¸Šå“ã•ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚  
- RefinementãŒmiddlehighä»¥ä¸Šã®ã¨ãã¯ã€éœ²éª¨ãªå˜èªã‚’é¿ã‘ã€å©‰æ›²ãƒ»æ¯”å–©ãƒ»è©©çš„è¡¨ç¾ã‚’å¤šç”¨ã—ã¦ãã ã•ã„ã€‚  ï¼ˆlowâ†’middleâ†’middlehighâ†’highï¼‰
- Mutableãªè¦ç´ ï¼ˆåæ¯ãƒ»å‘»ããƒ»æ‚²é³´ï¼‰ã¯ãƒ¢ãƒ‡ãƒ«ã«å¿œã˜ã¦æŠ‘åˆ¶ã—ã¦ãã ã•ã„ã€‚  
- Mutableå€¤ãŒ[****:ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸]ã®å½¢ã§æ–‡ä¸­ã«ç™»å ´ã™ã‚‹ã¨ãã¯ã€ãã‚Œã‚’æ—¢å®šå€¤ã¨ã—ã€ãƒ¢ãƒ‡ãƒ«ã”ã¨ã®AdjustMutableå€ç‡ã‚’ã‹ã‘ã¦ä¸‹ã•ã„ã€‚  
è©²å½“ã—ãªã„å ´åˆã¯ã€AdjustMutableã®å€ç‡ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ä¸‹ã•ã„ã€‚
- æ„Ÿæƒ…ãã®ã‚‚ã®ã¯æŠ‘ãˆãšã€è¡¨ç¾ã®å‡ºã—æ–¹ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚
`;
        
        return finalParamControl + "\n" + streamContent + "\n" + finalInstructions;
    }

    // --- Share / Export Logic ---
    function openShareModal() { document.getElementById('shareModal').style.display = 'flex'; }
    function getAllText() { return generateFinalPrompt(); } // Updated to use the new generator

    async function shareContent(mode) { 
        const rawText = getAllText(); 
        const textToShare = (mode === 'code') ? "```markdown\n" + rawText + "\n```" : rawText; 
        const title = (mode === 'code') ? "Prompt Code" : "Prompt Text"; 
        if (navigator.share) { try { await navigator.share({ title: title, text: textToShare }); } catch (err) { if(err.name !== 'AbortError') alert("Share failed: " + err); } } else { navigator.clipboard.writeText(textToShare); alert("Web Share API not supported.\nCopied to clipboard!"); } 
        document.getElementById('shareModal').style.display = 'none'; 
    }
    
    async function shareAsFile(ext) { 
        const text = getAllText(); const fileName = `PROMPT_${new Date().toISOString().slice(0,10)}.${ext}`; const file = new File([text], fileName, { type: 'text/plain' }); 
        if (navigator.canShare && navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'Prompt File', text: 'Sending Prompt File...' }); } catch (err) { if(err.name !== 'AbortError') alert("File Share failed: " + err); } } else { downloadFile(ext); } 
        document.getElementById('shareModal').style.display = 'none'; 
    }
    
    function downloadFile(ext) { const text = getAllText(); const blob = new Blob([text], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `PROMPT_${new Date().toISOString().slice(0,10)}.${ext}`; a.click(); }

    // --- General Save/Load ---
    function saveToLocal() { 
        const data = []; 
        document.querySelectorAll('#streamList .card').forEach(card => {
            // Save text, type, AND control overrides
            data.push({ 
                type: card.dataset.type, 
                text: card.querySelector('textarea').value,
                controls: card.dataset.controls 
            }); 
        }); 
        localStorage.setItem('promptStreamMobile', JSON.stringify(data)); 
    }
    
    function clearBoard() { 
        if(confirm("Clear board?")) { 
            document.getElementById('streamList').innerHTML = '<p style="text-align:center; color:var(--border-color); font-size:12px; margin-top:50px;">TAP PALETTE TO START</p>'; 
            saveToLocal(); 
        } 
    }
    
    // Initial Load
    window.onload = function() {
        loadGlobalSettings(); // Globalè¨­å®šã‚’æœ€åˆã«ãƒ­ãƒ¼ãƒ‰

        // Restore Mode
        const savedMode = localStorage.getItem('promptMode') || 'rapid';
        document.body.classList.remove('mode-rapid', 'mode-standard');
        document.body.classList.add(`mode-${savedMode}`);

        // Restore Data
        const saved = localStorage.getItem('promptStreamMobile');
        if (saved) {
            const data = JSON.parse(saved);
            if(data.length > 0) {
                document.getElementById('streamList').innerHTML = '';
                data.forEach(item => {
                    addNewCard(item.type, item.text);
                    // å¾©å…ƒã—ãŸã‚«ãƒ¼ãƒ‰ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                    const lastCard = document.querySelector('#streamList .card:last-child');
                    if (item.controls) {
                        lastCard.dataset.controls = item.controls;
                        reflectLocalControls(lastCard);
                    }
                });
            }
        }
    };
  </script>
</body>
</html>
