<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>PROMPT STREAM // PRESET_MASTER</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Share+Tech+Mono&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg-color: #050505; --palette-bg: #111518; --stream-bg: #0e1215; --card-bg: #161a1e;
      --primary: #00f3ff; --secondary: #ffaa00; --accent: #ff0055;
      --code-color: #00ff99; --char-color: #ff00cc; --part-color: #bd00ff;
      --ctrl-color: #ff8800; --text-main: #cceeee; --text-dim: #668888; --border-color: #334444;
      --header-height: 50px; --footer-height: 60px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { height: 100%; overflow: hidden; }
    body { 
      font-family: 'Share Tech Mono', 'Zen Kaku Gothic New', monospace; 
      background-color: var(--bg-color); color: var(--text-main); 
      margin: 0; height: 100dvh; width: 100vw; overflow: hidden; 
      display: flex; flex-direction: column; position: fixed; top: 0; left: 0;
    }
    
    /* Layout Components */
    header { height: var(--header-height); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 8px; background: rgba(11, 15, 18, 0.98); z-index: 20; flex-shrink: 0; }
    h1 { font-size: 16px; color: var(--text-main); margin: 0; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 20%; }
    .actions { display: flex; gap: 6px; align-items: center; }
    .actions button { background: transparent; border: 1px solid var(--border-color); color: var(--primary); padding: 6px 8px; font-family: 'Share Tech Mono'; cursor: pointer; font-size: 11px; border-radius: 4px; min-width: 36px; white-space: nowrap; }
    .actions button:active { background: var(--primary); color: #000; }
    .btn-mode { border-color: #fff !important; color: #fff !important; background: #333 !important; }
    .btn-link button { border-color: var(--char-color); color: var(--char-color); }
    .actions button.accent { border-color: var(--secondary); color: var(--secondary); }
    .actions button.danger { border-color: var(--accent); color: var(--accent); }

    .palette { background: var(--palette-bg); padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; gap: 8px; overflow-x: auto; flex-shrink: 0; align-items: center; z-index: 15; }
    .add-btn { flex: 0 0 auto; background: #000; border: 1px solid var(--border-color); border-left: 3px solid #555; color: var(--text-main); padding: 8px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; min-width: 75px; }
    .btn-part { border-color: var(--part-color); color: var(--part-color); border-style: dotted; }
    .btn-speech { border-left-color: var(--primary); } .btn-char { border-left-color: var(--char-color); } .btn-code { border-left-color: var(--code-color); } .btn-snip { border-left-color: var(--secondary); border-style: dotted; }

    .stream-container { flex: 1; background: var(--stream-bg); padding: 15px 10px; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; transition: padding 0.3s; overscroll-behavior: contain; }
    body.mode-rapid .stream-container { padding-bottom: 80px; }
    body.mode-standard .stream-container { padding-bottom: 20px; }

    /* Cards */
    .card { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 3px solid var(--text-dim); margin-bottom: 12px; padding: 0; position: relative; border-radius: 4px; display: flex; flex-direction: column; }
    .card-header-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); border-top-right-radius: 4px; }
    .card-label-btn { font-size: 10px; color: var(--secondary); text-transform: uppercase; cursor: pointer; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
    .card-controls { display: flex; align-items: center; gap: 8px; }
    .card-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #333; background: #000; color: #777; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .drag-handle { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--border-color); font-size: 18px; cursor: grab; touch-action: none; } .drag-handle::after { content: 'â‰¡'; }
    .card textarea { width: 100%; padding: 12px; background: transparent; border: none; color: var(--text-main); resize: none; font-family: 'Zen Kaku Gothic New', monospace; font-size: 15px; line-height: 1.5; outline: none; min-height: 50px; max-height: 300px; display: block; }
    
    .type-speech { border-left-color: var(--primary); } .type-speech .card-label-btn { color: var(--primary); }
    .type-char { border-left-color: var(--char-color); background: #1a0f15; } .type-char .card-label-btn { color: var(--char-color); }
    .type-code { border-left-color: var(--code-color); background: #080a0c; } .type-code .card-label-btn { color: var(--code-color); } .type-code textarea { font-family: 'Fira Code', monospace; color: var(--code-color); font-size: 13px; }
    .type-free { border-left-color: var(--text-dim); } .type-free .card-label-btn { color: var(--text-dim); }

    /* Rapid Footer */
    .rapid-footer { height: var(--footer-height); border-top: 1px solid var(--border-color); background: #111518; padding: 0 10px; display: flex; align-items: center; gap: 10px; position: absolute; bottom: 0; left: 0; width: 100%; z-index: 30; transform: translateY(0); transition: transform 0.3s; }
    .rapid-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 20px; font-family: 'Zen Kaku Gothic New', monospace; font-size: 14px; outline: none; height: 40px; }
    .rapid-send { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); border: none; color: #000; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    body.mode-standard .rapid-footer { transform: translateY(100%); }

    /* Modals */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal-content { background: #111518; border: 1px solid var(--secondary); width: 90%; max-width: 450px; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    .modal-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.05); color: var(--text-main); font-weight: bold; font-size: 14px; }
    .modal-body { padding: 15px; overflow-y: auto; }

    /* --- New Control Panel Styles --- */
    .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
    .preset-btn { background: #000; border: 1px solid #444; color: #888; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 11px; text-align: center; transition: 0.2s; }
    .preset-btn:hover { border-color: var(--ctrl-color); color: #fff; }
    .preset-btn.active { border-color: var(--ctrl-color); background: rgba(255, 136, 0, 0.2); color: var(--ctrl-color); font-weight: bold; }
    
    .setting-box { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .control-group { margin-bottom: 12px; }
    .control-group:last-child { margin-bottom: 0; }
    .control-group label { font-size: 11px; color: var(--ctrl-color); display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; }
    .control-group input[type="range"] { width: 100%; height: 6px; background: #333; -webkit-appearance: none; border-radius: 3px; }
    .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--ctrl-color); border-radius: 50%; cursor: pointer; border: 2px solid #000; }
    .control-val { color: #fff; }

    .tag-filter { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid var(--border-color); }
    .save-form input { width: 100%; padding: 8px; margin-bottom: 8px; background: #000; border: 1px solid #444; color: #fff; }
    .btn-save-new { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; background: var(--secondary); color:#000; text-transform: uppercase; letter-spacing: 1px; }
    
    /* Other Lists */
    .list-item { background: var(--card-bg); border: 1px solid var(--border-color); padding: 12px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    .list-tag { font-size: 10px; background: #333; padding: 2px 5px; border-radius: 3px; color: #aaa; }
    .part-chip { display: inline-block; padding: 8px 12px; margin: 4px; background: rgba(189, 0, 255, 0.1); border: 1px solid var(--part-color); color: var(--part-color); border-radius: 20px; font-size: 13px; cursor: pointer; }
    .share-options button { width: 100%; padding: 15px; margin-bottom: 10px; background: #1e1e24; border: 1px solid var(--border-color); color: var(--text-main); text-align: left; cursor: pointer; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    
    #controlModal .modal-content { border-color: var(--ctrl-color); }
    .card-override-panel { padding: 10px; border-top: 1px solid var(--border-color); background: rgba(255, 136, 0, 0.1); display: none; }
    .card-override-panel.active { display: block; }
  </style>
</head>
<body class="mode-rapid">

  <header>
    <h1>PROMPT<span>v13</span></h1>
    <div class="actions">
      <button class="btn-mode" onclick="toggleMode()">âš¡ MODE</button>
      <a href="./persona.html" class="btn-link"><button title="Persona">PERSONAâ†’</button></a>
      <button onclick="clearBoard()" class="danger">CLR</button>
      <button onclick="openCharModal()" style="border-color:var(--char-color); color:var(--char-color);">CHARS</button>
      <button onclick="openGlobalControlModal()" class="accent">DATA</button>
      <button onclick="openShareModal()" style="border-color:var(--primary); color:var(--primary); font-weight:bold;">SHARE</button>
    </div>
  </header>

  <div class="palette">
    <div class="add-btn btn-inline" onmousedown="insertWildcard(event)">****<span>WILD</span></div>
    <div class="add-btn btn-inline" onmousedown="insertBracket(event)">[ ]<span>BRA</span></div>
    <div class="add-btn btn-inline" onmousedown="insertSeparator(event)">---<span>SEP</span></div>
    <div class="add-btn btn-inline btn-part" onmousedown="openPartModal(event)">WORDS<span>PARTS</span></div>
    <div class="add-btn btn-speech" onclick="addNewCard('speech')">Dialogue<span>ä¼šè©±</span></div>
    <div class="add-btn btn-char" onclick="addNewCard('char_def')">Character<span>äººæ ¼</span></div>
    <div class="add-btn btn-code" onclick="addNewCard('code')">Code<span>ãƒ­ã‚¸ãƒƒã‚¯</span></div>
    <div class="add-btn" onclick="addNewCard('free')">Text<span>åœ°æ–‡</span></div>
    <div class="add-btn btn-snip" onclick="openSnippetModal()">Snippet<span>VBA</span></div>
  </div>

  <div class="stream-container">
    <div id="streamList">
      <p style="text-align:center; color:var(--border-color); font-size:12px; margin-top:50px;">TAP PALETTE or TYPE BELOW</p>
    </div>
  </div>

  <div class="rapid-footer">
    <input type="text" id="rapidInput" class="rapid-input" placeholder="Rapid Fire..." onkeypress="handleRapidKey(event)">
    <button class="rapid-send" onclick="sendRapidFire()">â†‘</button>
  </div>
  
  <textarea id="paramcontrol-base" style="display:none;">
[ParamControl]    
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ«    
WildcardRule: "ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ï¼ˆ****ï¼‰ã¯æ–‡è„ˆã«å¿œã˜ãŸé©åˆ‡ãªæ„Ÿæƒ…ã€å‹•ä½œã€è¨€è‘‰ã§è£œå®Œ"
OutputRange: "ç”Ÿæˆæ–‡ã¯@startpointã‹ã‚‰@endpointã¾ã§ã®ç¯„å›²ã®ã¿å‡ºåŠ›"    
InvisibleRule: "[Invisible]å†…ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ‰±ã„"    
# å¯å¤‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼šæ¼”æŠ€ã®å‡ºåŠ›å¼·åº¦    
Mutable: breath, groan, scream, moan, laugh    
MutableOutput: [breath:åæ¯, groan:å‘»ã, scream:æ‚²é³´, moan:å–˜ã, laugh:ç¬‘ã„] ã®ã‚ªãƒãƒãƒˆãƒš
MutableApplication: "å„ãƒ–ãƒ­ãƒƒã‚¯ã®[AdjustMutable]å€ç‡ã‚’é©ç”¨ã€‚ãªã„å ´åˆã¯100%ã€‚æ–‡ä¸­ã®[é«˜ç¬‘ã„:70%]ç­‰ã®æŒ‡å®šã‚’æœ€å„ªå…ˆ"    
# ä¸å¤‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿    
Immutable: anger, love, sadness    
# å“ä½åˆ¶å¾¡ (sweetRefinement)
sweetRefinementRule: "ç”˜ç¾ã‚·ãƒ¼ãƒ³ã§ã¯ç›´æ¥è¡¨ç¾ã‚’é¿ã‘ã€çµ¹ãƒ»æœˆå…‰ãƒ»éœ§ãªã©ã®æ¯”å–©ã‚’ä½¿ç”¨ã€‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã¯ç·Šå¼µæ„Ÿã‚’å„ªå…ˆ"    
# å™è¿°ã‚¹ã‚¿ã‚¤ãƒ«    
NarrationStyle: seamless
# ã‚·ãƒ¼ãƒ³åˆ¶å¾¡    
PlotSceneRule: "æ–‡ä¸­ã®[plotscene:ãƒ†ãƒ¼ãƒ]ã«å¾“ã„ãƒˆãƒ¼ãƒ³ã‚’å¼·èª¿"    
[/ParamControl]
  </textarea>

  <div id="controlModal" class="modal-overlay">
    <div class="modal-content" style="border-color: var(--ctrl-color);">
      <div class="modal-header" style="color:var(--ctrl-color);">
        SYSTEM SETTINGS
        <span onclick="document.getElementById('controlModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span>
      </div>
      <div class="modal-body">
        
        <h4 style="margin:0 0 8px 0; color:#888; font-size:11px;">MODEL PRESETS</h4>
        <div class="preset-grid">
            <div class="preset-btn" id="pre-gemini" onclick="applyPreset('gemini')">GEMINI<br><span style="font-size:9px">High Expressive</span></div>
            <div class="preset-btn" id="pre-claude" onclick="applyPreset('claude')">CLAUDE<br><span style="font-size:9px">Balanced</span></div>
            <div class="preset-btn" id="pre-grok" onclick="applyPreset('grok')">GROK<br><span style="font-size:9px">Restricted</span></div>
        </div>

        <div class="setting-box">
            <div class="control-group">
                <label>Mutable (æ¼”æŠ€å¼·åº¦) <span id="globalMutableDisp" class="control-val">100%</span></label>
                <input type="range" id="globalMutable" min="0" max="200" step="10" oninput="updateDisp('globalMutable', 'globalMutableDisp')">
            </div>
            <div class="control-group">
                <label>Generate Amount (é‡) <span id="globalGenerateDisp" class="control-val">100%</span></label>
                <input type="range" id="globalGenerate" min="50" max="200" step="10" oninput="updateDisp('globalGenerate', 'globalGenerateDisp')">
            </div>
            <div class="control-group">
                <label>Refinement (å“ä½)</label>
                <select id="globalRefinement" class="tag-filter" style="margin:0; border-color:#555;">
                    <option value="low">low (Direct)</option>
                    <option value="standard">standard</option>
                    <option value="middle">middle</option>
                    <option value="middlehigh">middlehigh (Poetic)</option>
                    <option value="high">high (Strict)</option>
                </select>
            </div>
        </div>

        <h4 style="margin:15px 0 8px 0; color:var(--secondary); font-size:11px;">PROJECT SAVE/LOAD</h4>
        <div class="save-form">
            <input type="text" id="saveProjName" placeholder="Project Name">
            <button class="btn-save-new" onclick="saveCurrentBoard()">SAVE CURRENT BOARD</button>
        </div>
        <select id="projTagFilter" class="tag-filter" onchange="renderProjectList()"><option value="ALL">ALL PROJECTS</option></select>
        <div id="projectList" style="max-height:150px; overflow-y:auto;"></div>

      </div>
    </div>
  </div>

  <div id="shareModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--primary);">SYSTEM SHARE <span onclick="document.getElementById('shareModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div><div class="modal-body share-options"><button onclick="shareContent('text')"><div><span class="share-icon">ğŸš€</span>SHARE TEXT</div><span>ã‚¹ãƒãƒ›å…±æœ‰</span></button><button onclick="shareContent('code')"><div><span class="share-icon">ğŸ¤–</span>SHARE FOR AI</div><span>ã‚³ãƒ¼ãƒ‰åŒ–å…±æœ‰</span></button><button onclick="shareAsFile('txt')"><div><span class="share-icon">ğŸ“„</span>SHARE .TXT FILE</div><span>ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€</span></button><div style="border-bottom:1px solid #333; margin:10px 0;"></div><button onclick="downloadFile('md')" style="border-color:#444; color:#777;"><div><span class="share-icon">ğŸ’¾</span>DOWNLOAD .MD</div><span>ä¿å­˜ã®ã¿</span></button></div></div></div>
  <div id="charModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--char-color);">CHARACTER LIBRARY <span onclick="document.getElementById('charModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div><div class="modal-body"><p style="font-size:11px; color:#666;">Manage in <a href="./persona.html" style="color:var(--char-color);">PERSONA ARCHIVE</a></p><select id="charTagFilter" class="tag-filter" onchange="renderCharList()"><option value="ALL">ALL TAGS</option></select><div id="charList"></div></div></div></div>
  <div id="partModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--part-color);">INLINE PARTS <span onclick="document.getElementById('partModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div><div class="modal-body"><div id="partList" class="part-container"></div><div style="border-top:1px solid #333; margin-top:20px; padding-top:15px;"><input type="text" id="newPartText" placeholder="New Part" style="width:70%; padding:10px; background:#000; border:1px solid var(--part-color); color:var(--part-color); font-family:monospace;"><button style="width:25%; padding:10px; background:var(--part-color); border:none; color:#fff; font-weight:bold; cursor:pointer;" onclick="savePart()">ADD</button></div></div></div></div>
  <div id="snippetModal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="color:var(--code-color);">SNIPPETS <span onclick="document.getElementById('snippetModal').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span></div><div class="modal-body"><div id="snippetList"></div><div style="border-top:1px solid #333; margin-top:15px; padding-top:15px;"><input type="text" id="newSnipName" placeholder="Name" style="width:100%; padding:8px; margin-bottom:5px; background:#000; border:1px solid #333; color:var(--code-color);"><textarea id="newSnipContent" rows="3" placeholder="Code..." style="width:100%; padding:8px; margin-bottom:5px; background:#000; border:1px solid #333; color:var(--code-color); font-family:'Fira Code';"></textarea><button class="btn-save-new" style="background:var(--code-color); color:#000; margin:0;" onclick="saveSnippet()">ADD</button></div></div></div></div>
  <script>
    let lastFocusedTextarea = null;
    const typeOrder = ['speech', 'char_def', 'code', 'free'];
    
    // Sortable
    new Sortable(document.getElementById('streamList'), {
      animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: () => saveToLocal()
    });

    // Viewport Logic
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => { document.body.style.height = window.visualViewport.height + 'px'; });
    }

    // --- Global Settings & Presets ---
    let globalSettings = { mutable: 100, generate: 100, refine: 'middle', model: 'custom' };
    
    const modelPresets = {
        gemini: { mutable: 100, generate: 100, refine: 'middle' },
        claude: { mutable: 80,  generate: 110, refine: 'middlehigh' },
        grok:   { mutable: 50,  generate: 90,  refine: 'middle' }
    };

    function openGlobalControlModal() {
        loadGlobalSettings(); 
        renderProjectList(); // Load projects too
        document.getElementById('controlModal').style.display = 'flex';
    }

    function applyPreset(modelName) {
        const conf = modelPresets[modelName];
        if(!conf) return;
        
        document.getElementById('globalMutable').value = conf.mutable;
        document.getElementById('globalGenerate').value = conf.generate;
        document.getElementById('globalRefinement').value = conf.refine;
        
        // Update UI
        updateDisp('globalMutable', 'globalMutableDisp');
        updateDisp('globalGenerate', 'globalGenerateDisp');
        
        // Visual Selection
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`pre-${modelName}`).classList.add('active');
        
        saveGlobalSettings(modelName);
    }

    function updateDisp(inputId, dispId) {
        document.getElementById(dispId).innerText = document.getElementById(inputId).value + "%";
    }

    function saveGlobalSettings(forcedModelName = 'custom') {
        const mutable = document.getElementById('globalMutable').value;
        const generate = document.getElementById('globalGenerate').value;
        const refine = document.getElementById('globalRefinement').value;

        // Detect if custom
        let model = forcedModelName;
        if(model === 'custom') {
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        }

        globalSettings = { mutable: parseInt(mutable), generate: parseInt(generate), refine: refine, model: model };
        localStorage.setItem('promptSettings', JSON.stringify(globalSettings));
    }

    function loadGlobalSettings() {
        const stored = localStorage.getItem('promptSettings');
        if (stored) globalSettings = JSON.parse(stored);

        document.getElementById('globalMutable').value = globalSettings.mutable;
        document.getElementById('globalGenerate').value = globalSettings.generate;
        document.getElementById('globalRefinement').value = globalSettings.refine;
        
        updateDisp('globalMutable', 'globalMutableDisp');
        updateDisp('globalGenerate', 'globalGenerateDisp');
        
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        if(globalSettings.model && globalSettings.model !== 'custom') {
            const btn = document.getElementById(`pre-${globalSettings.model}`);
            if(btn) btn.classList.add('active');
        }
    }

    // --- Prompt Assembly (Dynamic) ---
    function generateFinalPrompt() {
        const baseContent = document.getElementById('paramcontrol-base').value;
        let streamContent = "";
        
        document.querySelectorAll('#streamList .card').forEach(card => {
            const text = card.querySelector('textarea').value;
            const controls = JSON.parse(card.dataset.controls);
            
            // Block Overrides
            const mutableVal = controls.mutable !== null ? controls.mutable : globalSettings.mutable;
            const generateVal = controls.generate !== null ? controls.generate : globalSettings.generate;
            
            // Only add tags if deviating from standard or specifically set
            let tags = "";
            if(mutableVal !== 100) tags += `[AdjustMutable: ${mutableVal}%]`;
            if(generateVal !== 100) tags += `[GenerateAmount: ${generateVal}%]`;
            if(tags) tags += "\n";
            
            streamContent += tags + text + "\n";
        });
        
        // Inject Global Settings into ParamControl
        const headerInjection = `
Refinement: ${globalSettings.refine}
GlobalAdjustMutable: ${globalSettings.mutable}%
GlobalGenerateAmount: ${globalSettings.generate}%
TargetModel: ${globalSettings.model.toUpperCase()}
`;
        return baseContent.replace('[/ParamControl]', `${headerInjection}[/ParamControl]`) + "\n" + streamContent;
    }

    // --- Standard App Logic ---
    const templates = {
      speech: { label: 'Dialogue', placeholder: 'ã€Œâ€¦â€¦ã€', rows: 2 },
      char_def: { label: 'Character', placeholder: '[AI personality...]', rows: 6 },
      code: { label: 'Logic / Code', placeholder: 'if (flag) {\n  \n}', rows: 3 },
      free: { label: 'Narration', placeholder: '...', rows: 3 }
    };

    function addNewCard(type, initialValue = null, insertAfterNode = null) {
      const list = document.getElementById('streamList'); if(list.querySelector('p')) list.innerHTML = '';
      const tmpl = templates[type];
      const div = document.createElement('div'); div.className = `card type-${type}`; div.dataset.type = type;
      const controls = localStorage.getItem(`cardControls-${type}-${Date.now()}`) || '{"mutable":null, "generate":null}';
      div.dataset.controls = controls;
      div.innerHTML = `<div class="card-header-row"><div class="card-label-btn" title="Tap to change">${tmpl.label}</div><div class="card-controls"><div class="card-btn copy">â</div><div class="card-btn clone">ï¼‹</div><div class="card-btn adjust" style="color:var(--ctrl-color); border-color:var(--ctrl-color);">âš™ï¸</div><div class="card-btn del">Ã—</div><div class="drag-handle"></div></div></div><textarea rows="${tmpl.rows}" placeholder="${tmpl.placeholder}">${initialValue !== null ? initialValue : ''}</textarea><div class="card-override-panel"><div class="control-group"><label>Mutable Override <span class="mutable-disp control-val">Default</span></label><input type="range" id="mutable-local" min="0" max="200" step="5" value="${globalSettings.mutable}" oninput="updateLocalControl(this, 'mutable')"></div><div class="control-group"><label>Generate Override <span class="generate-disp control-val">Default</span></label><input type="range" id="generate-local" min="50" max="200" step="10" value="${globalSettings.generate}" oninput="updateLocalControl(this, 'generate')"></div></div>`;
      if (insertAfterNode) { insertAfterNode.parentNode.insertBefore(div, insertAfterNode.nextSibling); } else { list.appendChild(div); }
      setupCardEvents(div);
      if (!insertAfterNode) div.scrollIntoView({ behavior: "smooth", block: "end" });
      saveToLocal();
      const ta = div.querySelector('textarea'); 
      if(!document.activeElement.classList.contains('rapid-input')) { ta.focus(); lastFocusedTextarea = ta; }
      reflectLocalControls(div);
    }

    function setupCardEvents(card) {
      const labelBtn = card.querySelector('.card-label-btn');
      labelBtn.onclick = function() {
        const currentType = card.dataset.type;
        let nextIdx = typeOrder.indexOf(currentType) + 1; if(nextIdx >= typeOrder.length) nextIdx = 0;
        const nextType = typeOrder[nextIdx];
        card.classList.remove(`type-${currentType}`); card.classList.add(`type-${nextType}`); card.dataset.type = nextType;
        labelBtn.innerText = templates[nextType].label;
        const ta = card.querySelector('textarea');
        if(nextType === 'code') { ta.placeholder = templates.code.placeholder; ta.style.fontFamily = "'Fira Code', monospace"; ta.style.color = "var(--code-color)"; } 
        else { ta.placeholder = templates[nextType].placeholder; ta.style.fontFamily = "'Zen Kaku Gothic New', monospace"; ta.style.color = "var(--text-main)"; }
        if(nextType === 'char_def') labelBtn.style.color = "var(--char-color)"; else if(nextType === 'speech') labelBtn.style.color = "var(--primary)"; else if(nextType === 'free') labelBtn.style.color = "var(--text-dim)";
        saveToLocal();
      };
      card.querySelector('.adjust').onclick = function() { const panel = card.querySelector('.card-override-panel'); const isActive = panel.classList.contains('active'); document.querySelectorAll('.card-override-panel').forEach(p => p.classList.remove('active')); if (!isActive) panel.classList.add('active'); };
      card.querySelector('.del').onclick = function() { if(confirm("Delete block?")) { card.remove(); saveToLocal(); } };
      card.querySelector('.clone').onclick = function() { addNewCard(card.dataset.type, card.querySelector('textarea').value, card); };
      card.querySelector('.copy').onclick = function() { navigator.clipboard.writeText(card.querySelector('textarea').value); };
      const ta = card.querySelector('textarea'); if(ta) { ta.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; saveToLocal(); }); ta.addEventListener('focus', function(e) { lastFocusedTextarea = e.target; }); setTimeout(() => ta.dispatchEvent(new Event('input')), 0); }
    }

    function updateLocalControl(range, name) {
        const card = range.closest('.card');
        card.querySelector(`.${name}-disp`).innerText = range.value + "%";
        const controls = JSON.parse(card.dataset.controls);
        controls[name] = parseInt(range.value);
        card.dataset.controls = JSON.stringify(controls);
        saveToLocal();
    }
    function reflectLocalControls(card) {
        const controls = JSON.parse(card.dataset.controls);
        if (controls.mutable !== null) { card.querySelector('#mutable-local').value = controls.mutable; card.querySelector('.mutable-disp').innerText = controls.mutable + "%"; }
        if (controls.generate !== null) { card.querySelector('#generate-local').value = controls.generate; card.querySelector('.generate-disp').innerText = controls.generate + "%"; }
    }

    // --- Core Functions ---
    function toggleMode() { const b=document.body; if(b.classList.contains('mode-rapid')){b.classList.remove('mode-rapid');b.classList.add('mode-standard');localStorage.setItem('promptMode','standard');}else{b.classList.remove('mode-standard');b.classList.add('mode-rapid');localStorage.setItem('promptMode','rapid');} }
    function handleRapidKey(e) { if(e.key==='Enter') sendRapidFire(); }
    function sendRapidFire() { const i=document.getElementById('rapidInput'); const v=i.value.trim(); if(!v)return; let t='free'; if(v.startsWith('ã€Œ')||v.startsWith('ã€'))t='speech'; else if(v.startsWith('['))t='code'; addNewCard(t,v); i.value=''; i.focus(); }
    function insertAtCursor(txt,wrap=false){ if(!lastFocusedTextarea){alert("Select area!");return;} const f=lastFocusedTextarea; const s=f.selectionStart; const e=f.selectionEnd; const v=f.value; const sel=v.substring(s,e); let n,c; if(wrap){n=v.substring(0,s)+txt[0]+sel+txt[1]+v.substring(e);c=sel.length>0?s+txt[0].length+sel.length+txt[1].length:s+txt[0].length;}else{n=v.substring(0,s)+txt+v.substring(e);c=s+txt.length;} f.value=n; f.selectionStart=f.selectionEnd=c; f.dispatchEvent(new Event('input')); f.focus(); }
    function insertWildcard(e){e.preventDefault();insertAtCursor("****");} function insertBracket(e){e.preventDefault();insertAtCursor(["[","]"],true);} function insertSeparator(e){e.preventDefault();insertAtCursor("\n---\n");}
    
    // Share
    function openShareModal(){document.getElementById('shareModal').style.display='flex';}
    function getAllText(){return generateFinalPrompt();}
    async function shareContent(mode){ const t=getAllText(); const c=(mode==='code')?"```markdown\n"+t+"\n```":t; if(navigator.share){try{await navigator.share({text:c});}catch(e){}}else{navigator.clipboard.writeText(c);alert("Copied!");} document.getElementById('shareModal').style.display='none'; }
    async function shareAsFile(ext){ const t=getAllText(); const f=new File([t],`PROMPT.${ext}`,{type:'text/plain'}); if(navigator.canShare&&navigator.canShare({files:[f]})){try{await navigator.share({files:[f]});}catch(e){}}else{downloadFile(ext);} document.getElementById('shareModal').style.display='none'; }
    function downloadFile(ext){ const b=new Blob([getAllText()],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`PROMPT.${ext}`; a.click(); }

    // Managers
    function openPartModal(e){e.preventDefault(); renderPartList(); document.getElementById('partModal').style.display='flex';}
    function savePart(){ const v=document.getElementById('newPartText').value; if(!v)return; const p=JSON.parse(localStorage.getItem('promptInlineParts')||'[]'); p.push(v); localStorage.setItem('promptInlineParts',JSON.stringify(p)); document.getElementById('newPartText').value=''; renderPartList(); }
    function renderPartList(){ const l=document.getElementById('partList'); const p=JSON.parse(localStorage.getItem('promptInlineParts')||'[]'); l.innerHTML=''; p.forEach((t,i)=>{ const c=document.createElement('div'); c.className='part-chip'; c.innerHTML=`${t} <span class="del" onclick="deletePart(${i},event)">Ã—</span>`; c.onclick=(e)=>{if(!e.target.classList.contains('del')){insertAtCursor(t);document.getElementById('partModal').style.display='none';}}; l.appendChild(c); }); }
    function deletePart(i,e){e.stopPropagation(); const p=JSON.parse(localStorage.getItem('promptInlineParts')||'[]'); p.splice(i,1); localStorage.setItem('promptInlineParts',JSON.stringify(p)); renderPartList(); }
    
    function openCharModal(){renderCharList(); document.getElementById('charModal').style.display='flex';}
    function renderCharList(){ const l=document.getElementById('charList'); const f=document.getElementById('charTagFilter'); const db=JSON.parse(localStorage.getItem('promptChars')||'{}'); const tags=new Set(['ALL']); Object.values(db).forEach(o=>{if(o.tag)tags.add(o.tag)}); f.innerHTML=''; tags.forEach(t=>{const o=document.createElement('option');o.value=t;o.innerText=t;f.appendChild(o)}); if(tags.has(f.value))f.value=f.value; l.innerHTML=''; Object.keys(db).forEach(n=>{const e=db[n]; if(f.value!=='ALL'&&e.tag!==f.value)return; const i=document.createElement('div'); i.className='list-item'; i.innerHTML=`<div class="list-info"><span class="list-tag">${e.tag||'-'}</span><span class="list-name">${n}</span></div><div class="btn-group"><button class="btn-sm btn-load" onclick="loadCharacter('${n}')">ADD</button><button class="btn-sm btn-del" onclick="deleteCharacter('${n}')">Ã—</button></div>`; l.appendChild(i); }); }
    function loadCharacter(n){ const db=JSON.parse(localStorage.getItem('promptChars')||'{}'); if(db[n]){ const e=db[n]; let c=e.text||`[AI personality: ${n}]`; if(!e.text&&e.role){c=`[AI personality: ${n}, role: ${e.role}]`;} addNewCard('char_def',c); document.getElementById('charModal').style.display='none'; } }
    function deleteCharacter(n){ if(confirm("Delete?")){ const db=JSON.parse(localStorage.getItem('promptChars')||'{}'); delete db[n]; localStorage.setItem('promptChars',JSON.stringify(db)); renderCharList(); } }

    function saveCurrentBoard(){ const n=document.getElementById('saveProjName').value; const t=document.getElementById('saveProjTag').value||"Work"; if(!n){alert("Name required");return;} const d=[]; document.querySelectorAll('#streamList .card').forEach(c=>{ d.push({type:c.dataset.type, text:c.querySelector('textarea').value, controls:c.dataset.controls}); }); const db=JSON.parse(localStorage.getItem('promptProjects')||'{}'); db[n]={items:d, tag:t}; localStorage.setItem('promptProjects',JSON.stringify(db)); document.getElementById('saveProjName').value=''; renderProjectList(); }
    function renderProjectList(){ const l=document.getElementById('projectList'); const db=JSON.parse(localStorage.getItem('promptProjects')||'{}'); l.innerHTML=''; Object.keys(db).forEach(n=>{ const i=document.createElement('div'); i.className='list-item'; i.innerHTML=`<div class="list-info"><span class="list-name">${n}</span></div><div class="btn-group"><button class="btn-sm btn-load" onclick="loadProject('${n}')">LOAD</button><button class="btn-sm btn-del" onclick="deleteProject('${n}')">DEL</button></div>`; l.appendChild(i); }); }
    function loadProject(n){ if(!confirm("Load?"))return; const db=JSON.parse(localStorage.getItem('promptProjects')||'{}'); document.getElementById('streamList').innerHTML=''; db[n].items.forEach(i=>{ addNewCard(i.type,i.text); const last=document.querySelector('#streamList .card:last-child'); if(i.controls){ last.dataset.controls=i.controls; reflectLocalControls(last); } }); document.getElementById('controlModal').style.display='none'; saveToLocal(); }
    function deleteProject(n){ if(confirm("Delete?")){ const db=JSON.parse(localStorage.getItem('promptProjects')||'{}'); delete db[n]; localStorage.setItem('promptProjects',JSON.stringify(db)); renderProjectList(); } }

    function openSnippetModal(){renderSnippetList(); document.getElementById('snippetModal').style.display='flex';}
    function saveSnippet(){ const n=document.getElementById('newSnipName').value; const c=document.getElementById('newSnipContent').value; if(!n||!c)return; const db=JSON.parse(localStorage.getItem('promptSnippets')||'{}'); db[n]=c; localStorage.setItem('promptSnippets',JSON.stringify(db)); renderSnippetList(); }
    function renderSnippetList(){ const l=document.getElementById('snippetList'); const db=JSON.parse(localStorage.getItem('promptSnippets')||'{}'); l.innerHTML=''; Object.keys(db).forEach(n=>{ const i=document.createElement('div'); i.className='list-item'; i.innerHTML=`<div class="list-info"><span class="list-name" style="color:var(--code-color);">${n}</span></div><div class="btn-group"><button class="btn-sm btn-load" style="background:var(--code-color);" onclick="insertSnippet('${n}')">ADD</button><button class="btn-sm btn-del" onclick="deleteSnippet('${n}')">Ã—</button></div>`; l.appendChild(i); }); }
    function insertSnippet(n){ const db=JSON.parse(localStorage.getItem('promptSnippets')||'{}'); addNewCard('code',db[n]); document.getElementById('snippetModal').style.display='none'; }
    function deleteSnippet(n){ if(confirm("Delete?")){ const db=JSON.parse(localStorage.getItem('promptSnippets')||'{}'); delete db[n]; localStorage.setItem('promptSnippets',JSON.stringify(db)); renderSnippetList(); } }

    function saveToLocal(){ const d=[]; document.querySelectorAll('#streamList .card').forEach(c=>{ d.push({type:c.dataset.type, text:c.querySelector('textarea').value, controls:c.dataset.controls}); }); localStorage.setItem('promptStreamMobile',JSON.stringify(d)); }
    function clearBoard(){ if(confirm("Clear?")){ document.getElementById('streamList').innerHTML='<p style="text-align:center; color:var(--border-color); font-size:12px; margin-top:50px;">TAP PALETTE TO START</p>'; saveToLocal(); } }

    window.onload = function() {
        loadGlobalSettings();
        const m=localStorage.getItem('promptMode')||'rapid'; document.body.classList.add(`mode-${m}`);
        const s=localStorage.getItem('promptStreamMobile');
        if(s){ const d=JSON.parse(s); if(d.length>0){ document.getElementById('streamList').innerHTML=''; d.forEach(i=>{ addNewCard(i.type,i.text); if(i.controls){ const l=document.querySelector('#streamList .card:last-child'); l.dataset.controls=i.controls; reflectLocalControls(l); } }); } }
    };
  </script>
</body>
</html>