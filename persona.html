<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PERSONA // ARCHIVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #0a0005;
      --card-bg: #1a0510;
      --char-primary: #ff00cc;
      --char-dim: #884466;
      --text-main: #ffccEE;
      --border-color: #441133;
      --header-height: 50px;
      --info-explicit: #00f3ff;
      --info-implicit: #ffaa00;
      --info-secret: #ff0055;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Share Tech Mono', 'Zen Kaku Gothic New', monospace; background: var(--bg-color); color: var(--text-main); margin: 0; height: 100dvh; display: flex; flex-direction: column; }
    
    header { height: var(--header-height); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; background: rgba(20, 0, 10, 0.95); flex-shrink: 0; }
    h1 { font-size: 16px; color: var(--char-primary); letter-spacing: 2px; margin: 0; }
    
    .actions { display: flex; gap: 8px; }
    .btn-header { background: transparent; color: var(--char-primary); border: 1px solid var(--char-primary); padding: 6px 10px; font-weight: bold; border-radius: 4px; cursor: pointer; font-family: 'Share Tech Mono'; font-size: 11px; }
    .btn-header.filled { background: var(--char-primary); color: #000; }
    .btn-header.back { color: #ccc; border-color: #555; text-decoration: none; display: flex; align-items: center; }

    .container { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 35%; border-right: 1px solid var(--border-color); overflow-y: auto; background: rgba(0,0,0,0.2); }
    .char-item { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; }
    .char-item:hover, .char-item.active { background: rgba(255, 0, 204, 0.1); border-left: 3px solid var(--char-primary); }
    .char-tag { font-size: 10px; color: var(--char-dim); border: 1px solid var(--char-dim); padding: 1px 4px; border-radius: 4px; margin-bottom: 4px; display: inline-block; }
    .char-name { font-weight: bold; font-size: 14px; display: block; }

    .editor { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    label { font-size: 11px; color: var(--char-dim); margin-bottom: 4px; display: flex; justify-content: space-between; }
    .label-badge { padding: 2px 6px; border-radius: 4px; color: #000; font-weight: bold; font-size: 10px; }
    
    input[type="text"], textarea { background: #000; border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; width: 100%; font-family: inherit; font-size: 13px; border-radius: 4px; }
    textarea { resize: vertical; line-height: 1.6; }
    input:focus, textarea:focus { outline: none; border-color: var(--char-primary); }

    .core-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: rgba(255, 0, 204, 0.03); }
    .core-field { margin-bottom: 5px; }
    .full-width { grid-column: 1 / -1; }

    .info-grid { display: grid; gap: 15px; margin-top: 10px; }
    .area-explicit textarea { border-color: rgba(0, 243, 255, 0.3); } .area-explicit textarea:focus { border-color: var(--info-explicit); }
    .area-implicit textarea { border-color: rgba(255, 170, 0, 0.3); } .area-implicit textarea:focus { border-color: var(--info-implicit); }
    .area-secret textarea { border-color: rgba(255, 0, 85, 0.3); background: #0f0005; } .area-secret textarea:focus { border-color: var(--info-secret); }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 999; display: none; align-items: center; justify-content: center; }
    .modal-content { background: #111518; border: 1px solid var(--char-primary); width: 90%; max-width: 500px; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; padding: 20px; }
    .modal-h { color: var(--char-primary); margin: 0 0 15px 0; font-size: 16px; font-weight: bold; display: flex; justify-content: space-between; }
    .btn-modal { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

    @media (max-width: 600px) { .container { flex-direction: column; } .sidebar { width: 100%; height: 120px; flex-shrink: 0; } .editor { flex: 1; } .core-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<header>
  <h1>PERSONA<span>//ARCHIVE</span></h1>
  <div class="actions">
    <a href="./index.html" class="btn-header back">← STREAM</a>
    <button class="btn-header" onclick="openDataModal()">DATA</button>
    <button class="btn-header" onclick="createNew()">NEW</button>
    <button class="btn-header filled" onclick="saveCurrent()">SAVE</button>
  </div>
</header>

<div class="container">
  <div class="sidebar" id="sidebar"></div>
  <div class="editor" id="editorArea">
    <div style="display:flex; gap:10px;">
      <div style="flex:1;">
        <label>NAME</label>
        <input type="text" id="inpName" placeholder="Character Name">
      </div>
      <div style="flex:1;">
        <label>TAG (Free Input)</label>
        <input type="text" id="inpTag" placeholder="Input or Select Tag" list="tagList">
        <datalist id="tagList"></datalist>
      </div>
    </div>
    
    <div><label>CAST / IMAGE</label><input type="text" id="inpCast" placeholder="Actor, Image URL..."></div>

    <div>
      <label>CORE PERSONALITY [AI personality: ... ]</label>
      <div class="core-grid">
        <div class="core-field full-width"><label>Role</label><input type="text" id="inpRole" placeholder="Role..."></div>
        <div class="core-field"><label>Age/Gender</label><input type="text" id="inpAge" placeholder="Age..."></div>
        <div class="core-field"><label>Pronoun</label><input type="text" id="inpPronoun" placeholder="Pronoun..."></div>
        <div class="core-field full-width"><label>Addressing</label><input type="text" id="inpAddr" placeholder="Addressing..."></div>
        <div class="core-field full-width"><label>Memot</label><input type="text" id="inpMemot" placeholder="Memot..."></div>
        <div class="core-field full-width"><label>Language</label><input type="text" id="inpLang" placeholder="Language..."></div>
        <div class="core-field full-width"><label>Refinement</label><input type="text" id="inpRefine" placeholder="Refinement..."></div>
      </div>
    </div>

    <div><label>DIALOGUE SAMPLES</label><textarea id="inpDialogue" rows="4" placeholder="「……」"></textarea></div>

    <div class="info-grid">
      <div class="area-explicit"><label>EXPLICIT (明示)</label><textarea id="inpExplicit" rows="2" placeholder="Public info..."></textarea></div>
      <div class="area-implicit"><label>IMPLICIT (暗示)</label><textarea id="inpImplicit" rows="2" placeholder="Hint info..."></textarea></div>
      <div class="area-secret"><label>SECRET (秘匿)</label><textarea id="inpSecret" rows="2" placeholder="Secret info..."></textarea></div>
    </div>
    <div style="margin-top:10px;"><label>MEMO</label><textarea id="inpMemo" rows="2" style="color:#777; border-style:dashed;" placeholder="Personal notes..."></textarea></div>
    <button onclick="deleteCurrent()" style="background:transparent; border:1px solid #ff4444; color:#ff4444; padding:8px; border-radius:4px; margin-top:20px;">DELETE CHARACTER</button>
  </div>
</div>

<div id="dataModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-h">DATA MANAGER <span onclick="document.getElementById('dataModal').style.display='none'" style="cursor:pointer;">×</span></div>
    <textarea id="jsonArea" rows="10" style="font-family:monospace; color:var(--char-primary); font-size:11px;" placeholder="Paste JSON here..."></textarea>
    <div style="display:flex; gap:10px;">
      <button class="btn-modal" style="background:#333; color:#fff;" onclick="copyJson()">COPY JSON</button>
      <button class="btn-modal" style="background:var(--char-primary); color:#000;" onclick="loadJson()">LOAD JSON</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'promptChars';
  let currentKey = null;

  function loadDB() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
  function saveDB(db) { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); renderList(); }

  // タグリストの自動更新機能
  function updateTagList(db) {
    const list = document.getElementById('tagList');
    const tags = new Set();
    Object.values(db).forEach(entry => { if(entry.tag) tags.add(entry.tag); });
    list.innerHTML = '';
    Array.from(tags).sort().forEach(tag => {
      const opt = document.createElement('option');
      opt.value = tag;
      list.appendChild(opt);
    });
  }

  function renderList() {
    const db = loadDB();
    updateTagList(db); // ここでタグリストも更新
    
    const sidebar = document.getElementById('sidebar');
    sidebar.innerHTML = '';
    const keys = Object.keys(db).sort();
    if(keys.length === 0) { sidebar.innerHTML = '<div style="padding:20px; color:#555; font-size:12px;">No Characters</div>'; return; }
    keys.forEach(name => {
      const entry = db[name];
      const div = document.createElement('div');
      div.className = `char-item ${currentKey === name ? 'active' : ''}`;
      div.innerHTML = `<span class="char-tag">${entry.tag || '-'}</span><span class="char-name">${name}</span>`;
      div.onclick = () => loadChar(name);
      sidebar.appendChild(div);
    });
  }

  function loadChar(name) {
    const db = loadDB();
    const entry = db[name];
    if (!entry) return;
    currentKey = name;
    
    document.getElementById('inpName').value = name;
    document.getElementById('inpTag').value = entry.tag || '';
    document.getElementById('inpCast').value = entry.cast || '';
    
    ['Role','Age','Pronoun','Addr','Memot','Lang','Refine'].forEach(k => {
        document.getElementById('inp'+k).value = entry[k.toLowerCase()] || '';
        // 旧フォーマット対応
        if(k==='Role' && !entry.role && entry.role===undefined && entry.text) document.getElementById('inpRole').value = "[Legacy Data] " + entry.text.substring(0,20)+"...";
    });

    document.getElementById('inpDialogue').value = entry.dialogue || '';
    document.getElementById('inpExplicit').value = entry.explicit || '';
    document.getElementById('inpImplicit').value = entry.implicit || '';
    document.getElementById('inpSecret').value   = entry.secret || '';
    document.getElementById('inpMemo').value     = entry.memo || '';
    renderList();
  }

  function saveCurrent() {
    const name = document.getElementById('inpName').value.trim();
    if (!name) { alert('Name required'); return; }
    const db = loadDB();
    if (currentKey && currentKey !== name) delete db[currentKey];
    
    db[name] = {
      tag: document.getElementById('inpTag').value, // ここに入力された内容がそのまま保存＝新タグ登録
      cast: document.getElementById('inpCast').value,
      role: document.getElementById('inpRole').value,
      age: document.getElementById('inpAge').value,
      pronoun: document.getElementById('inpPronoun').value,
      addressing: document.getElementById('inpAddr').value,
      memot: document.getElementById('inpMemot').value,
      language: document.getElementById('inpLang').value,
      refinement: document.getElementById('inpRefine').value,
      dialogue: document.getElementById('inpDialogue').value,
      explicit: document.getElementById('inpExplicit').value,
      implicit: document.getElementById('inpImplicit').value,
      secret:   document.getElementById('inpSecret').value,
      memo:     document.getElementById('inpMemo').value
    };
    saveDB(db);
    currentKey = name;
    const btn = document.querySelector('.btn-header.filled');
    const originalText = btn.innerText; btn.innerText = "OK!"; setTimeout(() => btn.innerText = originalText, 1000);
  }

  function createNew() {
    currentKey = null;
    document.querySelectorAll('input, textarea').forEach(el => el.value = '');
    renderList();
    document.getElementById('inpName').focus();
  }

  function deleteCurrent() {
    if(!currentKey) return;
    if(confirm('Delete character?')) { const db = loadDB(); delete db[currentKey]; saveDB(db); createNew(); }
  }

  function openDataModal() { document.getElementById('dataModal').style.display = 'flex'; document.getElementById('jsonArea').value = ''; }
  function copyJson() { navigator.clipboard.writeText(JSON.stringify(loadDB(), null, 2)); alert('JSON copied!'); }
    // ★★★ 強化版 LOAD JSON ★★★
  function loadJson() {
    const rawText = document.getElementById('jsonArea').value;
    if(!rawText) return;

    try {
      const inputData = JSON.parse(rawText);
      const currentDB = loadDB();
      let importCount = 0;

      // -------------------------------------------------------
      // Helper: 揺らぎのあるキーから値を取り出す関数
      // -------------------------------------------------------
      const getVal = (source, candidates) => {
        for (const key of candidates) {
          if (source[key] !== undefined && source[key] !== null) {
            // もし値がオブジェクトなら文字列化して返す（addressing対策）
            if (typeof source[key] === 'object' && !Array.isArray(source[key])) {
               return Object.entries(source[key]).map(([k, v]) => `${k}: ${v}`).join(', ');
            }
            return String(source[key]); // 文字列として返す
          }
        }
        return ""; // 見つからなければ空文字
      };

      // -------------------------------------------------------
      // Helper: 1キャラ分のデータを正規化して保存する関数
      // -------------------------------------------------------
      const processCharacter = (charObj, forceName = null) => {
        // 名前を探す (AI_personality, Name, name, character_name...)
        const name = forceName || getVal(charObj, ['AI_personality', 'Name', 'name', 'character_name', 'キャラ名']);
        
        if (!name) return false; // 名前がないデータはスキップ

        // 既存データがあればマージ、なければ新規作成
        const existing = currentDB[name] || {};

        currentDB[name] = {
          tag:        getVal(charObj, ['tag', 'genre', 'category']) || existing.tag || "",
          cast:       getVal(charObj, ['cast', 'image', 'actor']) || existing.cast || "",
          
          // Core Fields (揺らぎ吸収)
          role:       getVal(charObj, ['role', 'job', 'class']) || existing.role || "",
          age:        getVal(charObj, ['age', 'age_gender', 'gender']) || existing.age || "",
          pronoun:    getVal(charObj, ['pronoun', 'first_person']) || existing.pronoun || "",
          addressing: getVal(charObj, ['addressing', 'second_person']) || existing.addressing || "",
          memot:      getVal(charObj, ['memot', 'mind', 'trait']) || existing.memot || "",
          language:   getVal(charObj, ['language', 'tone', 'speech_style']) || existing.language || "",
          refinement: getVal(charObj, ['refinement', 'atmosphere', 'vibe']) || existing.refinement || "",

          // Text Areas
          dialogue:   getVal(charObj, ['dialogue', 'sample_voice', 'speech']) || existing.dialogue || "",
          explicit:   getVal(charObj, ['explicit', 'explicit_info']) || existing.explicit || "",
          implicit:   getVal(charObj, ['implicit', 'implicit_info']) || existing.implicit || "",
          secret:     getVal(charObj, ['secret', 'secret_info']) || existing.secret || "",
          memo:       getVal(charObj, ['memo', 'note']) || existing.memo || ""
        };
        return true;
      };

      // -------------------------------------------------------
      // Main Logic: 配列か、辞書か、単体か判定
      // -------------------------------------------------------
      
      // パターンA: 配列の場合 ( [ {char1}, {char2} ] )
      if (Array.isArray(inputData)) {
        inputData.forEach(item => { if(processCharacter(item)) importCount++; });
      } 
      // パターンB: 単体オブジェクトだが、キーがパラメータっぽい (今回提示されたケース)
      else if (inputData.AI_personality || inputData.name || inputData.role) {
        if(processCharacter(inputData)) importCount++;
      }
      // パターンC: アプリ標準のバックアップ形式 ( { "Name": {data}, "Name2": {data} } )
      else {
        Object.keys(inputData).forEach(key => {
          // キー自体を名前として扱い、中身をデータとする
          if(processCharacter(inputData[key], key)) importCount++;
        });
      }

      if (importCount > 0) {
        saveDB(currentDB);
        document.getElementById('dataModal').style.display = 'none';
        alert(`Imported ${importCount} character(s) successfully!`);
      } else {
        alert("No valid character data found in JSON.");
      }

    } catch(e) {
      console.error(e);
      alert('Invalid JSON format or structure.\nCheck console for details.'); 
    }
  }

  renderList();
</script>
</body>
</html>
